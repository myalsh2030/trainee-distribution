<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>توزيع المتدربين على لجان الاختبارات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="shared/css/main.css">
    <!-- Lucide Icons - Outline/Line Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for Distribution Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        /* Wizard Styles */
        .wizard-container {
            --row-padding: 6px 5px;
            /* Default row padding - level 3 */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
        }

        .wizard-header {
            background: var(--bg-card);
            padding: 20px;
            border-bottom: 1px solid var(--border-dark);
            text-align: center;
        }

        .wizard-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--accent-gold);
            margin-bottom: 5px;
        }

        .wizard-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Icon Buttons */
        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border-dark);
            background: var(--bg-card);
            color: var(--text-light);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--accent-gold);
            transform: scale(1.05);
        }

        /* Light Mode */
        body.light-mode {
            --bg-dark: #f5f7fa;
            --bg-card: #ffffff;
            --bg-table: #f0f2f5;
            --bg-header: #e8ecf4;
            --text-light: #1a202c;
            --text-muted: #4a5568;
            --border-dark: #d1d5db;
        }

        body.light-mode .wizard-container {
            background: var(--bg-dark);
        }

        body.light-mode .report-page {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        body.light-mode .alert.warning,
        body.light-mode .alert.info {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        body.light-mode .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        body.light-mode .disclaimer {
            background: #e0e7ff;
            color: #3730a3;
        }

        /* Age-based colors for report age */
        .age-normal {
            color: var(--accent-green);
        }

        .age-warning {
            color: #f59e0b;
            font-weight: 600;
        }

        .age-critical {
            color: #ef4444;
            font-weight: 700;
        }

        /* Steps Bar */
        .steps-bar {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: var(--bg-header);
            flex-wrap: wrap;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 25px;
            background: var(--bg-card);
            border: 1px solid var(--border-dark);
            cursor: not-allowed;
            transition: all 0.3s;
            opacity: 0.6;
        }

        .step.clickable {
            cursor: pointer;
            opacity: 1;
        }

        .step.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .step.active {
            border-color: var(--accent-gold);
            background: rgba(251, 191, 36, 0.1);
            opacity: 1;
        }

        .step.completed {
            border-color: var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
            opacity: 1;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--border-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
        }

        .step.active .step-number {
            background: var(--accent-gold);
            color: #000;
        }

        .step.completed .step-number {
            background: var(--accent-green);
            color: #fff;
        }

        .step-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .step.active .step-label {
            color: var(--accent-gold);
            font-weight: 600;
        }

        .step.completed .step-label {
            color: var(--accent-green);
        }

        /* Content Area */
        .wizard-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .step-content {
            display: none;
            max-width: 900px;
            margin: 0 auto;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Navigation */
        .wizard-nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: var(--bg-card);
            border-top: 1px solid var(--border-dark);
        }

        .nav-btn {
            padding: 12px 30px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-btn.prev {
            background: var(--bg-header);
            color: var(--text-light);
            border: 1px solid var(--border-dark);
        }

        .nav-btn.next {
            background: linear-gradient(135deg, var(--accent-gold), #f59e0b);
            color: #000;
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        /* Upload Section */
        .upload-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .upload-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-dark);
        }

        .upload-card h3 {
            font-size: 16px;
            color: var(--accent-gold);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-card .badge {
            background: var(--accent-gold);
            color: #000;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 11px;
        }

        .upload-card .badge.optional {
            background: var(--border-dark);
            color: var(--text-muted);
        }

        .upload-box {
            border: 2px dashed var(--border-dark);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .upload-box:hover {
            border-color: var(--accent-gold);
            background: rgba(251, 191, 36, 0.05);
        }

        .upload-box.loaded {
            border-color: var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .upload-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .file-info {
            margin-top: 15px;
            padding: 12px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 8px;
            font-size: 12px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-input {
            display: none;
        }

        /* Info Cards */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .info-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--border-dark);
        }

        .info-card .label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .info-card .value {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-gold);
        }

        /* Alert Box */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 13px;
        }

        .alert.error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--accent-red);
            color: #fca5a5;
        }

        .alert.success {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--accent-green);
            color: #86efac;
        }

        .alert.warning {
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid var(--accent-gold);
            color: #fcd34d;
        }

        .alert.info {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid var(--accent-blue);
            color: #93c5fd;
        }

        /* Select & Input */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .form-select,
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid var(--border-dark);
            background: var(--bg-card);
            color: var(--text-light);
            font-family: inherit;
            font-size: 14px;
        }

        .form-select:focus,
        .form-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* Course List */
        .course-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .course-filter input {
            flex: 1;
        }

        .course-list {
            border: 1px solid var(--border-dark);
            border-radius: 10px;
        }

        .course-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-dark);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .course-item:hover {
            background: rgba(251, 191, 36, 0.1);
        }

        .course-item.selected {
            background: rgba(59, 130, 246, 0.2);
            border-right: 3px solid var(--accent-blue);
        }

        .course-code {
            font-weight: 600;
            color: var(--accent-blue);
        }

        .course-name {
            color: var(--text-light);
            font-size: 12px;
        }

        .course-count {
            font-size: 18px;
            font-weight: 800;
            color: var(--accent-gold);
            background: rgba(251, 191, 36, 0.15);
            padding: 4px 12px;
            border-radius: 8px;
        }

        /* Committee Options */
        .committee-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .committee-option {
            background: var(--bg-card);
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .committee-option:hover {
            border-color: var(--accent-gold);
        }

        .committee-option.active {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .committee-option h4 {
            color: var(--accent-gold);
            margin-bottom: 10px;
            font-size: 14px;
        }

        .committee-option .input-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .committee-option input {
            max-width: 100px;
        }

        .committee-option .result {
            margin-top: 10px;
            font-size: 13px;
            color: var(--accent-green);
            font-weight: 600;
        }

        /* Room Selection - Grid */
        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            max-height: 250px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg-header);
            border-radius: 10px;
            margin-top: 10px;
        }

        .room-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            background: var(--bg-card);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            border: 1px solid transparent;
        }

        .room-checkbox:hover {
            border-color: var(--accent-gold);
        }

        .room-checkbox.selected {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--accent-green);
        }

        .room-checkbox.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .room-checkbox input {
            accent-color: var(--accent-green);
        }

        .room-status {
            background: var(--bg-card);
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-status .count {
            font-weight: 700;
            color: var(--accent-gold);
        }

        .room-search {
            margin-bottom: 10px;
        }

        /* Room Chips */
        .room-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .room-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .room-chip {
            background: var(--bg-header);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .room-chip .remove {
            cursor: pointer;
            color: var(--accent-red);
        }

        /* Building Cards */
        .buildings-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .building-card {
            padding: 12px 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-width: 120px;
        }

        .building-card:hover {
            border-color: var(--accent-gold);
        }

        .building-card.selected {
            border-width: 2px;
        }

        .building-card .name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-light);
        }

        .building-card .count {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Selected Rooms List (Sortable) */
        .selected-rooms-container {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .rooms-list-box {
            flex: 1;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--border-dark);
        }

        .rooms-list-box h4 {
            color: var(--text-light);
            margin-bottom: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sortable-rooms {
            min-height: 100px;
            background: var(--bg-header);
            border-radius: 8px;
            padding: 8px;
        }

        .sortable-room-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: grab;
            transition: all 0.2s;
            border-right: 4px solid;
        }

        .sortable-room-item:hover {
            transform: translateX(-3px);
        }

        .sortable-room-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .sortable-room-item .drag-handle {
            color: var(--text-muted);
            cursor: grab;
        }

        .sortable-room-item .room-name {
            flex: 1;
            font-size: 13px;
        }

        .sortable-room-item .building-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
        }

        .sortable-room-item .remove-btn {
            background: none;
            border: none;
            color: var(--accent-red);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .sortable-room-item .remove-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* Committee without room */
        .committee-pending {
            background: rgba(245, 158, 11, 0.15) !important;
            border-right: 3px solid #f59e0b !important;
        }



        /* Drag hint */
        .drag-hint {
            text-align: center;
            color: var(--text-muted);
            font-size: 11px;
            padding: 8px;
            background: var(--bg-header);
            border-radius: 6px;
            margin-bottom: 10px;
        }

        /* Add Committee Button */
        .add-committee-btn:hover {
            background: rgba(251, 191, 36, 0.15) !important;
            border-color: var(--accent-gold) !important;
            transform: scale(1.02);
        }

        .add-committee-row {
            background: transparent !important;
        }

        /* Distribution Preview */
        .distribution-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .distribution-table th,
        .distribution-table td {
            padding: 10px;
            border: 1px solid var(--border-dark);
            text-align: center;
        }

        .distribution-table th {
            background: var(--bg-header);
            color: var(--accent-gold);
            font-size: 12px;
        }

        .distribution-table td {
            font-size: 13px;
        }

        /* Sort Options */
        .sort-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 15px;
            background: var(--bg-card);
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sort-option:hover {
            border-color: var(--accent-gold);
        }

        .sort-option input:checked+span {
            color: var(--accent-gold);
            font-weight: 600;
        }

        /* Status Filter */
        .status-filter-container {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .status-list-box {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border-dark);
            border-radius: 10px;
            overflow: hidden;
        }

        .status-list-title {
            padding: 10px;
            font-weight: 600;
            font-size: 12px;
            text-align: center;
        }

        .status-list-title.included {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .status-list-title.excluded {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }

        .status-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
        }

        .status-item {
            padding: 6px 10px;
            margin: 4px 0;
            background: var(--bg-header);
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .status-item:hover {
            background: rgba(251, 191, 36, 0.15);
        }

        .status-item.selected {
            background: rgba(59, 130, 246, 0.3);
            border: 1px solid var(--accent-blue);
        }

        .status-item .count {
            background: var(--accent-gold);
            color: #000;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .status-transfer-buttons {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 8px;
        }

        .transfer-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-dark);
            background: var(--bg-card);
            color: var(--text-light);
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .transfer-btn:hover {
            background: var(--accent-gold);
            color: #000;
        }

        /* Report Preview */
        .report-page {
            background: #fff;
            margin-bottom: 20px;
        }

        .report-section {
            margin-bottom: 10px;
            background: #fff;
            color: #000;
            padding: 15px;
            border-radius: 10px;
        }

        .report-header {
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #333;
        }

        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .header-top-row .header-right {
            text-align: right;
            flex: 1;
        }

        .header-top-row .header-center {
            text-align: center;
            flex: 1;
            font-weight: 700;
        }

        .header-top-row .header-left {
            text-align: left;
            flex: 1;
            font-size: 12px;
            color: #666;
        }

        .report-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 800;
        }

        .report-header .info {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 14px;
            flex-wrap: wrap;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table th,
        .report-table td {
            border: 1px solid #333;
            padding: 8px;
            text-align: center;
            font-size: 10px;
        }

        .report-table th {
            background: #f0f0f0;
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 15px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-dark);
            border-top: 4px solid var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: var(--text-light);
            font-size: 14px;
        }

        /* Smooth Step Transitions */
        .step-content {
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .step-content.active {
            opacity: 1;
            transform: translateX(0);
        }

        /* Tooltip Enhancement */
        .step[title] {
            position: relative;
        }

        .step[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            color: var(--text-light);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 100;
            border: 1px solid var(--border-dark);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Responsive Design for Tablets */
        @media (max-width: 1024px) {
            .steps-bar {
                flex-wrap: wrap;
                gap: 8px;
                padding: 15px;
            }

            .step {
                flex: 1 1 auto;
                min-width: 80px;
            }

            .step-label {
                font-size: 10px;
            }

            .wizard-content {
                padding: 15px;
            }

            .upload-cards {
                grid-template-columns: 1fr;
            }

            .committee-options {
                flex-direction: column;
            }

            .committee-option {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .top-section {
                flex-direction: column;
                gap: 15px;
            }

            .step-number {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .step-label {
                display: none;
            }

            .header-controls {
                justify-content: center;
            }

            .preview-table-wrapper {
                overflow-x: auto;
            }
        }

        /* Keyboard Focus Indicators */
        .step:focus {
            outline: 2px solid var(--accent-gold);
            outline-offset: 2px;
        }

        .nav-btn:focus,
        .form-input:focus {
            outline: 2px solid var(--accent-gold);
            outline-offset: 2px;
        }


        @media print {
            @page {
                size: A4 portrait;
                margin: 8mm 10mm;
            }

            * {
                background: #fff !important;
                color: #000 !important;
            }

            html,
            body {
                margin: 0 !important;
                padding: 0 !important;
                background: #fff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Critical for fixed footer: Remove stacking contexts from outer containers only */
            body,
            .main-content-wrapper,
            .wizard-container,
            .wizard-content {
                position: static !important;
                overflow: visible !important;
                transform: none !important;
                filter: none !important;
                perspective: none !important;
                contain: none !important;
            }

            /* Table footer support */
            table {
                page-break-inside: auto;
            }

            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            thead {
                display: table-header-group;
            }

            tfoot {
                display: table-footer-group;
            }

            .wizard-container {
                background: #fff !important;
                min-height: auto !important;
            }

            .wizard-header,
            .steps-bar,
            .wizard-nav,
            .no-print,
            .toast-container,
            .alert {
                display: none !important;
            }

            .wizard-content {
                padding: 0 !important;
                background: #fff !important;
            }

            #step5 {
                background: #fff !important;
            }

            .report-page {
                page-break-after: always;
                background: #fff !important;
                padding: 0 !important;
            }

            .report-page:last-child {
                page-break-after: auto;
            }

            .report-section {
                background: #fff !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                border: none !important;
            }

            .report-header {
                margin-bottom: 4px !important;
                padding-bottom: 4px !important;
                border-bottom: 2px solid #000 !important;
            }

            .header-top-row {
                display: flex !important;
                justify-content: space-between !important;
                margin-bottom: 4px !important;
            }

            .header-top-row .header-right {
                flex: 1 !important;
                text-align: right !important;
                font-size: 9pt !important;
            }

            .header-top-row .header-center {
                flex: 1 !important;
                text-align: center !important;
                font-size: 12pt !important;
                font-weight: 700 !important;
            }

            .header-top-row .header-left {
                flex: 1 !important;
                text-align: left !important;
                font-size: 9pt !important;
            }

            .report-header h2 {
                font-size: 16pt !important;
                margin-bottom: 3px !important;
                font-weight: 800 !important;
            }

            .report-header .info {
                font-size: 10pt !important;
                gap: 15px !important;
            }

            .report-table {
                font-size: 10pt !important;
                background: #fff !important;
            }

            .report-table th,
            .report-table td {
                padding: var(--row-padding, 6px 5px) !important;
                border: 1px solid #000 !important;
                background: #fff !important;
            }

            .report-table th {
                background: #e0e0e0 !important;
                font-size: 10pt !important;
                font-weight: 700 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .report-table td {
                font-size: 10pt !important;
            }

            /* Allow trainee name to wrap */
            .report-table td:nth-child(3) {
                word-wrap: break-word !important;
                white-space: normal !important;
                max-width: 200px !important;
            }

            /* Keep trainee ID on one line */
            .report-table td:nth-child(2) {
                white-space: nowrap !important;
            }

            /* تكرار رأس الجدول في كل صفحة */
            .report-table thead {
                display: table-header-group !important;
            }

            .report-table tbody {
                display: table-row-group !important;
            }

            .report-table tr {
                page-break-inside: avoid !important;
            }
        }

        /* Additional Print Styles - Force each report on new page */
        @media print {
            .no-print {
                display: none !important;
            }

            #reportsContainer {
                display: block !important;
            }

            body {
                background: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .report-page {
                page-break-before: always;
                page-break-after: always;
                break-before: page;
                break-after: page;
                page-break-inside: avoid;
                break-inside: avoid;
            }

            .report-page:first-child {
                page-break-before: avoid;
                break-before: avoid;
            }

            .report-table {
                page-break-inside: avoid;
                break-inside: avoid;
            }

            .report-table tr {
                page-break-inside: avoid;
                break-inside: avoid;
            }
        }

        /* Committee Distribution Table */
        .committee-dist-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .committee-dist-toolbar button {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-dark);
            background: var(--bg-card);
            color: var(--text-light);
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .committee-dist-toolbar button:hover {
            background: var(--accent-blue);
            color: #fff;
        }

        .committee-dist-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .committee-dist-table th,
        .committee-dist-table td {
            padding: 10px 12px;
            text-align: center;
            border: 1px solid var(--border-dark);
        }

        .committee-dist-table th {
            background: var(--bg-header);
            color: var(--text-light);
            font-weight: 600;
        }

        .committee-dist-table tr.warning-row {
            background: rgba(239, 68, 68, 0.15);
        }

        .committee-dist-table tr.warning-row td:first-child {
            color: #ef4444;
            font-weight: 600;
        }

        .committee-dist-table .count-input {
            width: 60px;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid var(--border-dark);
            background: var(--bg-card);
            color: var(--text-light);
            text-align: center;
            font-size: 14px;
            font-family: inherit;
        }

        .committee-dist-table .count-input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .committee-dist-table .action-btn {
            padding: 6px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
        }

        .committee-dist-table .lock-btn {
            color: var(--accent-blue);
        }

        .committee-dist-table .lock-btn.locked {
            color: var(--accent-gold);
        }

        .committee-dist-table .delete-btn {
            color: #9ca3af;
        }

        .committee-dist-table .delete-btn:hover {
            color: #ef4444;
        }

        .total-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
        }

        .total-bar.balanced {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .total-bar.unbalanced {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* Print styles - Fixed column widths */
        @media print {
            .report-table {
                table-layout: fixed !important;
                width: 100% !important;
            }

            .report-table th,
            .report-table td {
                word-wrap: break-word;
                overflow: hidden;
                font-size: 12px !important;
                padding: 4px;
                padding: 4px;
                height: var(--print-row-height, 45px) !important;
                /* Fixed height for 2 rows */
                white-space: normal !important;
                /* Allow wrapping */
                overflow: hidden !important;
                /* Hide overflow */
                text-overflow: clip;
                vertical-align: middle;
                line-height: 1.2 !important;
            }

            /* Fixed column widths for print - 7 columns total */
            /* #1: م (تسلسلي - صغير جداً) */
            .report-table th:nth-child(1),
            .report-table td:nth-child(1) {
                width: 4% !important;
            }

            /* #2: رقم المتدرب (10 خانات) */
            .report-table th:nth-child(2),
            .report-table td:nth-child(2) {
                width: 11% !important;
            }

            /* #3: اسم المتدرب (طويل) */
            .report-table th:nth-child(3),
            .report-table td:nth-child(3) {
                width: 22% !important;
            }

            /* #4: اسم المقرر (طويل) */
            .report-table th:nth-child(4),
            .report-table td:nth-child(4) {
                width: 18% !important;
            }

            /* #5: الرقم المرجعي (7 خانات) */
            .report-table th:nth-child(5),
            .report-table td:nth-child(5) {
                width: 9% !important;
            }

            /* #6: المدرب (طويل) */
            .report-table th:nth-child(6),
            .report-table td:nth-child(6) {
                width: 20% !important;
            }

            /* #7: توقيع المتدرب (متوسط) */
            .report-table th:nth-child(7),
            .report-table td:nth-child(7) {
                width: 16% !important;
            }
        }
    </style>
</head>

<body>
    <div class="wizard-container">
        <!-- Header -->
        <div class="wizard-header">
            <div
                style="display:flex; justify-content:space-between; align-items:center; max-width:900px; margin:0 auto;">
                <div>
                    <h1 class="wizard-title" style="margin:0; display:flex; align-items:center; gap:10px;"><i
                            data-lucide="clipboard-list" style="width:28px; height:28px;"></i> توزيع المتدربين على لجان
                        الاختبارات</h1>
                    <p class="wizard-subtitle" style="margin:0;">م. محمد يوسف الشبيلي</p>
                </div>
                <div class="header-actions" style="display:flex; gap:10px;">
                    <button class="btn-icon" onclick="restoreDefaults()" title="استرجاع الافتراضي"><i
                            data-lucide="rotate-ccw" style="width:20px; height:20px;"></i></button>
                    <button class="btn-icon" onclick="showAboutModal()" title="معلومات التطبيق"><i data-lucide="info"
                            style="width:20px; height:20px;"></i></button>
                    <button class="btn-icon" id="themeToggle" onclick="toggleTheme()" title="تغيير المظهر"><i
                            data-lucide="moon" style="width:20px; height:20px;"></i></button>
                    <button class="btn-icon" onclick="newFile()" title="ملف جديد"><i data-lucide="folder-plus"
                            style="width:20px; height:20px;"></i></button>
                </div>
            </div>
        </div>

        <!-- Steps Bar -->
        <div class="steps-bar">
            <div class="step active clickable" data-step="1" onclick="goToStep(1)"
                title="رفع ملفات SF01 (إجباري) و SS01 (اختياري)"><span class="step-number">1</span><span
                    class="step-label">رفع الملفات</span></div>
            <div class="step" data-step="2" onclick="goToStep(2)" title="تصفية المتدربين حسب القسم وحالة التسجيل"><span
                    class="step-number">2</span><span class="step-label">الأقسام والحالات</span></div>
            <div class="step" data-step="3" onclick="goToStep(3)" title="اختيار المقررات التي تريد توزيع متدربيها"><span
                    class="step-number">3</span><span class="step-label">اختيار المقرر</span></div>
            <div class="step" data-step="4" onclick="goToStep(4)" title="تحديد عدد اللجان أو عدد المتدربين بكل لجنة">
                <span class="step-number">4</span><span class="step-label">عدد اللجان</span>
            </div>
            <div class="step" data-step="5" onclick="goToStep(5)" title="تعيين القاعات لكل لجنة وتخصيص التوزيع"><span
                    class="step-number">5</span><span class="step-label">توزيع القاعات</span></div>
            <div class="step" data-step="6" onclick="goToStep(6)" title="معاينة التقارير وطباعتها أو تصديرها"><span
                    class="step-number">6</span><span class="step-label">التقارير</span></div>
        </div>

        <!-- Content -->
        <div class="wizard-content">
            <!-- Step 1: Upload -->
            <div class="step-content active" id="step1">

                <div class="upload-cards">
                    <div class="upload-card">
                        <h3><span class="badge">إجباري</span> تقرير SF01</h3>
                        <p style="font-size:12px; color:var(--text-muted);">تقرير بيانات المتدربين والمقررات</p>
                        <div class="upload-box" id="sf01Box" onclick="document.getElementById('sf01Input').click()">
                            <span class="upload-icon"><i data-lucide="file-text"
                                    style="width:40px; height:40px;"></i></span>
                            <div style="font-weight:600;">اسحب الملف هنا أو انقر للاختيار</div>
                            <div style="font-size:11px; color:var(--text-muted);">CSV أو Excel</div>
                        </div>
                        <input type="file" class="file-input" id="sf01Input" accept=".csv,.xlsx,.xls">
                        <div class="file-info" id="sf01Info"></div>
                    </div>
                    <div class="upload-card">
                        <h3><span class="badge optional">اختياري</span> تقرير SS01</h3>
                        <p style="font-size:12px; color:var(--text-muted);">تقرير جدول الوحدة طولي (لتحديد القاعات)</p>
                        <div class="upload-box" id="ss01Box" onclick="document.getElementById('ss01Input').click()">
                            <span class="upload-icon"><i data-lucide="building"
                                    style="width:40px; height:40px;"></i></span>
                            <div style="font-weight:600;">اسحب الملف هنا أو انقر للاختيار</div>
                            <div style="font-size:11px; color:var(--text-muted);">CSV أو Excel</div>
                        </div>
                        <input type="file" class="file-input" id="ss01Input" accept=".csv,.xlsx,.xls">
                        <div class="file-info" id="ss01Info"></div>
                    </div>
                </div>
                <div class="alert success" style="margin-top:20px; text-align:center;">
                    <i data-lucide="shield-check" style="width:18px; height:18px; vertical-align:middle;"></i> تنويه:
                    البيانات تُعالج محلياً على جهازك ولا تُرسل لأي خادم
                </div>
            </div>

            <!-- Step 2: Departments and Status Filter -->
            <div class="step-content" id="step2">

                <div id="validationAlert"></div>

                <!-- Departments Section -->
                <div style="margin-bottom:25px;">
                    <h3 style="color:var(--text-light); margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                        <i data-lucide="landmark" style="width:20px; height:20px;"></i> الأقسام الموجودة في التقرير
                    </h3>
                    <div id="departmentsList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                </div>

                <!-- Status Filter Section -->
                <div id="statusFilterSection" style="margin-top:25px;">
                    <h3 style="color:var(--text-light); margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                        <i data-lucide="filter" style="width:20px; height:20px;"></i> تصفية حالات التسجيل
                    </h3>

                    <!-- Unknown Statuses Warning -->
                    <div id="unknownStatusesSection" style="display:none; margin-bottom:20px;">
                        <div class="alert warning" style="margin-bottom:10px;">
                            <i data-lucide="alert-triangle" style="width:16px; height:16px; vertical-align:middle;"></i>
                            يوجد حالات تسجيل غير معروفة. يجب تصنيفها قبل المتابعة:
                        </div>
                        <div class="status-list-box"
                            style="border-color: #f59e0b; background: rgba(245, 158, 11, 0.1);">
                            <div class="status-list-title" style="color: #f59e0b;"><i data-lucide="circle-help"
                                    style="width:16px; height:16px; vertical-align:middle;"></i> حالات تحتاج تصنيف</div>
                            <div class="status-list" id="unknownStatusesList"></div>
                        </div>
                        <div style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
                            <button class="nav-btn next" onclick="classifyUnknownAsIncluded()"
                                style="padding:8px 15px; font-size:12px; display:inline-flex; align-items:center; gap:4px;"><i
                                    data-lucide="plus" style="width:14px; height:14px;"></i> أضف للمسموحة</button>
                            <button class="nav-btn prev" onclick="classifyUnknownAsExcluded()"
                                style="padding:8px 15px; font-size:12px; display:inline-flex; align-items:center; gap:4px;"><i
                                    data-lucide="minus" style="width:14px; height:14px;"></i> أضف للمستبعدة</button>
                        </div>
                    </div>

                    <div class="status-filter-container">
                        <div class="status-list-box">
                            <div class="status-list-title included"><i data-lucide="check"
                                    style="width:14px; height:14px; vertical-align:middle;"></i> حالات التسجيل التي
                                ستظهر في الكشوف</div>
                            <div class="status-list" id="includedStatusesStep2"></div>
                        </div>
                        <div class="status-transfer-buttons">
                            <button class="transfer-btn" onclick="transferStatus('exclude')" title="استبعاد">←</button>
                            <button class="transfer-btn" onclick="transferStatus('include')" title="تضمين">→</button>
                        </div>
                        <div class="status-list-box">
                            <div class="status-list-title excluded"><i data-lucide="x"
                                    style="width:14px; height:14px; vertical-align:middle;"></i> حالات التسجيل المستبعدة
                                (لن تظهر في الكشوف)</div>
                            <div class="status-list" id="excludedStatusesStep2"></div>
                        </div>
                    </div>
                    <div id="statusSummaryStep2" style="margin-top:10px; font-size:12px; color:var(--text-muted);">
                    </div>

                    <!-- Status Summary - Enhanced (moved here after filter) -->
                    <div id="statusSummaryStyled"
                        style="background:var(--bg-card); border-radius:12px; padding:15px; margin-top:20px; border:1px solid var(--border-dark);">
                    </div>
                </div>
            </div>

            <!-- Step 3: Course Selection -->
            <div class="step-content" id="step3">

                <div class="form-group">
                    <h3 style="color:var(--text-light); margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                        <i data-lucide="landmark" style="width:20px; height:20px;"></i> اختر القسم:
                    </h3>
                    <div id="departmentButtons" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
                    </div>
                </div>
                <div class="form-group">
                    <h3 style="color:var(--text-light); margin-bottom:5px; display:flex; align-items:center; gap:8px;">
                        <i data-lucide="search" style="width:20px; height:20px;"></i> تصفية المقررات:
                    </h3>
                    <p style="font-size:11px; color:var(--text-muted); margin:0 0 12px 28px;">تم استبعاد المقررات بنوع
                        جدولة "عملي"</p>
                    <input type="text" class="form-input" id="courseFilter" placeholder="ابحث برمز أو اسم المقرر...">
                </div>

                <!-- Selected Courses Chip Bar -->
                <div id="selectedCoursesChipBar"
                    style="display:none; background:var(--bg-card); border-radius:12px; padding:12px; margin-bottom:15px; border:1px solid var(--accent-green);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <span style="color:var(--text-light); font-size:13px; font-weight:600;">
                            <i data-lucide="check-square" style="width:16px; height:16px; vertical-align:middle;"></i>
                            المقررات المختارة (<span id="selectedCoursesCount">0</span>):
                        </span>
                        <button id="clearAllCoursesBtn" onclick="clearAllSelectedCourses()"
                            style="display:none; background:rgba(239,68,68,0.15); color:#ef4444; border:none; padding:4px 10px; border-radius:6px; cursor:pointer; font-size:12px; font-family:inherit;">
                            <i data-lucide="trash-2" style="width:14px; height:14px; vertical-align:middle;"></i> إزالة
                            الكل
                        </button>
                    </div>
                    <div id="selectedCoursesChips" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                </div>

                <div class="course-list" id="courseList"></div>
            </div>

            <!-- Step 4: Committee Count (NEW) -->
            <div class="step-content" id="step4">
                <h2
                    style="text-align:center; color: var(--text-light); margin-bottom: 20px; display:flex; align-items:center; justify-content:center; gap:10px;">
                    <i data-lucide="settings" style="width:24px; height:24px;"></i> تحديد عدد اللجان
                </h2>

                <!-- Selected courses summary -->
                <div id="selectedCoursesSummary"
                    style="background:var(--bg-card); border-radius:12px; padding:15px; margin-bottom:20px; border:1px solid var(--border-dark);">
                </div>

                <div class="committee-options" id="committeeOptionsContainer">
                    <div class="committee-option active" id="optionByTrainees"
                        onclick="switchCommitteeMode('trainees')">
                        <h4 style="display:flex; align-items:center; gap:6px;"><i data-lucide="users"
                                style="width:18px; height:18px;"></i> تحديد عدد المتدربين بكل لجنة/قاعة</h4>
                        <div class="input-row">
                            <input type="number" class="form-input" id="traineesPerRoom" min="1" max="100" value="30"
                                oninput="updateCommitteeCalc()">
                            <span style="color:var(--text-muted);">متدرب</span>
                        </div>
                        <div class="result" id="roomsNeededResult"></div>
                    </div>
                    <div class="committee-option" id="optionByRooms" onclick="switchCommitteeMode('rooms')">
                        <h4 style="display:flex; align-items:center; gap:6px;"><i data-lucide="door-open"
                                style="width:18px; height:18px;"></i> تحديد عدد القاعات</h4>
                        <div class="input-row">
                            <input type="number" class="form-input" id="committeeCount" min="1" max="50" value="1"
                                oninput="updateCommitteeCalc()">
                            <span style="color:var(--text-muted);">قاعة</span>
                        </div>
                        <div class="result" id="traineesPerRoomResult"></div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Room Distribution (was step4) -->
            <div class="step-content" id="step5">
                <h2
                    style="text-align:center; color: var(--text-light); margin-bottom: 20px; display:flex; align-items:center; justify-content:center; gap:10px;">
                    <i data-lucide="building-2" style="width:24px; height:24px;"></i> توزيع القاعات/اللجان
                </h2>
                <div id="roomSelectionMode"></div>
                <div id="distributionPreview"></div>

                <!-- Distribution Chart -->
                <div id="chartContainer" class="no-print"
                    style="background:var(--bg-card); border-radius:16px; padding:20px; margin-top:20px; border:1px solid var(--border-dark); display:none;">
                    <h3
                        style="color:var(--text-light); margin-bottom:15px; display:flex; align-items:center; gap:10px; font-size:15px;">
                        <i data-lucide="bar-chart-3" style="width:20px; height:20px;"></i> توزيع المتدربين على اللجان
                    </h3>
                    <div style="max-height:300px; position:relative;">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Step 6: Reports (was step5) -->
            <div class="step-content" id="step6">
                <!-- Sort Options -->
                <div class="no-print"
                    style="background:var(--bg-card); border-radius:12px; padding:15px; margin-bottom:20px; border:1px solid var(--border-dark);">
                    <h3 style="color:var(--text-light); margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                        <i data-lucide="arrow-up-down" style="width:20px; height:20px;"></i> ترتيب المتدربين
                    </h3>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
                        <label class="sort-option">
                            <input type="radio" name="sortOrder" value="referenceNumber" checked
                                onchange="generateReports()">
                            <span>حسب الرقم المرجعي</span>
                        </label>
                        <label class="sort-option">
                            <input type="radio" name="sortOrder" value="instructor" onchange="generateReports()">
                            <span>حسب اسم المدرب</span>
                        </label>
                        <label class="sort-option">
                            <input type="radio" name="sortOrder" value="traineeName" onchange="generateReports()">
                            <span>حسب حرف الاسم الأول</span>
                        </label>
                        <label class="sort-option">
                            <input type="radio" name="sortOrder" value="traineeId" onchange="generateReports()">
                            <span>حسب الرقم التدريبي</span>
                        </label>
                    </div>
                </div>

                <!-- Export Sections Container (Side by Side) -->
                <div class="no-print"
                    style="display:flex; gap:20px; margin-bottom:20px; flex-wrap:wrap; align-items:stretch;">

                    <!-- Print Settings Box -->
                    <div
                        style="flex:2; min-width:300px; background:var(--bg-card); border-radius:16px; padding:20px; border:2px solid var(--accent-gold); display:flex; flex-direction:column;">
                        <h3
                            style="color:var(--accent-gold); margin-bottom:15px; display:flex; align-items:center; gap:10px; font-size:15px;">
                            <i data-lucide="printer" style="width:20px; height:20px;"></i> إعدادات الطباعة و PDF
                        </h3>

                        <!-- Settings Content -->
                        <div style="flex:1;">
                            <!-- Row Height Control -->
                            <div
                                style="background:var(--bg-header); border-radius:10px; padding:12px; margin-bottom:12px;">
                                <h4
                                    style="color:var(--text-light); margin-bottom:10px; display:flex; align-items:center; gap:6px; font-size:12px;">
                                    <i data-lucide="rows-3" style="width:16px; height:16px;"></i> عدد الصفوف في الصفحة
                                </h4>
                                <div style="display:flex; align-items:center; justify-content:center; gap:12px;">
                                    <span style="color:var(--text-muted); font-size:12px;">أكثر</span>
                                    <div
                                        style="display:flex; align-items:center; position:relative; flex:1; max-width:200px;">
                                        <div
                                            style="position:absolute; top:50%; left:0; right:0; height:2px; background:var(--border-dark); transform:translateY(-50%);">
                                        </div>
                                        <div
                                            style="display:flex; align-items:center; justify-content:space-between; width:100%; z-index:1;">
                                            <div class="row-height-circle" data-level="1" onclick="setRowHeight(1)"
                                                style="width:16px; height:16px; border-radius:50%; background:var(--bg-header); border:2px solid var(--border-dark); cursor:pointer;"
                                                title="صغير جداً"></div>
                                            <div class="row-height-circle" data-level="2" onclick="setRowHeight(2)"
                                                style="width:16px; height:16px; border-radius:50%; background:var(--bg-header); border:2px solid var(--border-dark); cursor:pointer;"
                                                title="صغير"></div>
                                            <div class="row-height-circle active" data-level="3"
                                                onclick="setRowHeight(3)"
                                                style="width:16px; height:16px; border-radius:50%; background:var(--accent-green); border:2px solid var(--accent-green); cursor:pointer;"
                                                title="متوسط"></div>
                                            <div class="row-height-circle" data-level="4" onclick="setRowHeight(4)"
                                                style="width:16px; height:16px; border-radius:50%; background:var(--bg-header); border:2px solid var(--border-dark); cursor:pointer;"
                                                title="كبير"></div>
                                            <div class="row-height-circle" data-level="5" onclick="setRowHeight(5)"
                                                style="width:16px; height:16px; border-radius:50%; background:var(--bg-header); border:2px solid var(--border-dark); cursor:pointer;"
                                                title="كبير جداً"></div>
                                        </div>
                                    </div>
                                    <span style="color:var(--text-muted); font-size:12px;">أقل</span>
                                </div>
                            </div>

                            <!-- Trainees Per Page Control -->
                            <div
                                style="background:var(--bg-header); border-radius:10px; padding:12px; display:flex; align-items:center; justify-content:space-between;">
                                <h4
                                    style="color:var(--text-light); margin:0; display:flex; align-items:center; gap:6px; font-size:12px;">
                                    <i data-lucide="users" style="width:16px; height:16px;"></i> عدد المتدربين في الصفحة
                                </h4>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <input type="number" id="traineesPerPage" placeholder="بدون تحديد"
                                        style="width:80px; padding:6px; border-radius:6px; border:1px solid var(--border-dark); background:var(--bg-card); color:var(--text-primary); text-align:center; direction:ltr;"
                                        onchange="generateReports()">
                                    <span style="color:var(--text-muted); font-size:12px;">متدرب / صفحة</span>
                                </div>
                            </div>

                            <!-- Signature Footer Option -->
                            <div
                                style="background:var(--bg-header); border-radius:10px; padding:12px; margin-top:12px; display:flex; align-items:center; justify-content:space-between;">
                                <label
                                    style="color:var(--text-light); display:flex; align-items:center; gap:8px; font-size:12px; cursor:pointer;">
                                    <input type="checkbox" id="showSignatureFooter" checked
                                        style="width:16px; height:16px; accent-color:var(--accent-gold); cursor:pointer;"
                                        onchange="generateReports()">
                                    <i data-lucide="pen-line" style="width:16px; height:16px;"></i>
                                    إضافة تذييل التوقيعات
                                </label>
                            </div>
                        </div>

                        <!-- Print Button -->
                        <button class="nav-btn next" onclick="printReports()"
                            style="display:flex; align-items:center; justify-content:center; gap:8px; padding:10px 20px; width:100%; margin-top:15px;">
                            <i data-lucide="printer" style="width:18px; height:18px;"></i> طباعة / تصدير PDF
                        </button>
                    </div>

                    <!-- Excel Export Box -->
                    <div
                        style="flex:1; min-width:180px; background:var(--bg-card); border-radius:16px; padding:20px; border:2px solid var(--accent-green); display:flex; flex-direction:column;">
                        <h3
                            style="color:var(--accent-green); margin-bottom:15px; display:flex; align-items:center; gap:10px; font-size:15px;">
                            <i data-lucide="file-spreadsheet" style="width:20px; height:20px;"></i> تصدير Excel
                        </h3>

                        <!-- Description -->
                        <div style="flex:1; display:flex; align-items:center; justify-content:center;">
                            <p style="color:var(--text-muted); font-size:14px; text-align:center; line-height:1.8;">
                                تصدير جميع اللجان<br>في ملف Excel واحد
                            </p>
                        </div>

                        <!-- Excel Button -->
                        <button class="nav-btn prev" onclick="exportToExcel()"
                            style="display:flex; align-items:center; justify-content:center; gap:8px; padding:10px 20px; background:rgba(16, 185, 129, 0.15); border:2px solid var(--accent-green); color:var(--accent-green); width:100%;">
                            <i data-lucide="download" style="width:18px; height:18px;"></i> تحميل Excel
                        </button>
                    </div>
                </div>
                <div id="reportsContainer" style="display:none;"></div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="wizard-nav">
        <button class="nav-btn prev" id="prevBtn" onclick="previousStep()" disabled>→ السابق</button>
        <button class="nav-btn next" id="nextBtn" onclick="nextStep()">التالي ←</button>
    </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script src="shared/js/utils.js"></script>
    <script src="shared/js/export.js"></script>
    <script>
        // Global State
        let currentStep = 1;
        let maxReachedStep = 1;
        let sf01Data = null, ss01Data = null;
        let sf01FileDate = null, ss01FileDate = null;
        let selectedDepartment = null, selectedCourse = null;
        let selectedCourseTraineeCount = 0;
        let committeeCount = 1;
        let committeeMode = 'trainees'; // 'rooms' or 'trainees' - default is trainees
        let traineesPerCommittee = 30; // Default trainees per committee
        let roomNames = [];
        let allRoomsInBuilding = [];
        let selectedBuildings = []; // Array of selected building names
        let roomsWithBuilding = []; // [{room: 'قاعة 101', building: 'مبنى أ', colorIndex: 0}, ...]
        let committeeRooms = []; // Array of length committeeCount, each element is room object or null
        const buildingColors = [
            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
            '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
        ]; // 10 colors for buildings

        // Status Filter - Predefined lists
        const defaultIncludedStatuses = [
            'مقرر مسجل عن طريق مدير النظام',
            'مقرر مسجل عن طريق الويب',
            'مقرر مسجل عن طريق االويب',
            'مقرر معاد قيده لتعديل الحرمان'
        ];
        const defaultExcludedStatuses = [
            'انسحاب فصلي',
            'مطوي قيده',
            'حرمان بسبب غياب',
            'مطوي قيده لإنقطاع أسبوعين'
        ];
        let includedStatuses = [];
        let excludedStatuses = [];
        let unknownStatuses = []; // New: statuses not in predefined lists
        let allStatuses = {};
        let selectedStatusItem = null;
        let sortOrder = 'traineeId';
        let traineesPerPage = 20; // Default trainees per page for PDF
        let selectedCourses = []; // Array for multiple course selection
        let committeeDistribution = []; // [{name: 'لجنة 1', count: 15, locked: false}, ...]
        let totalTraineesCount = 0; // Total trainees for selected courses
        // Configure app database (uses shared utils.js)
        configureDB('traineeDistributionDB');

        // New File - calls shared clearAllData()
        function newFile() {
            if (confirm('هل أنت متأكد من رغبتك برفع ملف جديد وتجاهل هذه البيانات؟')) {
                clearAllData().then(() => location.reload());
            }
        }

        // Auto-restore on load
        async function restoreData() {
            try {
                const sf01Result = await loadFromIndexedDB('sf01Data');
                const ss01Result = await loadFromIndexedDB('ss01Data');
                const dateResult = await loadFromIndexedDB('sf01FileDate');

                if (sf01Result?.rawData && sf01Result.rawData.length > 0) {
                    sf01Data = sf01Result.rawData;
                    sf01FileDate = dateResult?.rawData ? new Date(dateResult.rawData) : new Date();
                    maxReachedStep = 2;
                    currentStep = 2;

                    // Calculate age like in normal upload
                    const now = new Date();
                    const diff = now - sf01FileDate;
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                    // Age-based color class
                    let ageClass = 'age-normal';
                    if (days > 5) ageClass = 'age-critical';
                    else if (days > 2) ageClass = 'age-warning';

                    document.getElementById('sf01Box').classList.add('loaded');
                    document.getElementById('sf01Info').innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div><strong>[OK] تم استعادة البيانات</strong></div>
                            <button onclick="deleteReport('sf01')" title="حذف التقرير" 
                                    style="background:none; border:none; color:var(--accent-red); cursor:pointer; padding:4px;">
                                <i data-lucide="trash-2" style="width:16px; height:16px;"></i>
                            </button>
                        </div>
                        <div>تاريخ الملف: ${sf01FileDate.toLocaleDateString('ar-SA')}</div>
                        <div class="${ageClass}">عمر التقرير: ${days} يوم و ${hours} ساعة و ${minutes} دقيقة</div>
                        <div>عدد السجلات: ${sf01Data.length}</div>
                    `;
                    document.getElementById('sf01Info').classList.add('show');
                    if (typeof lucide !== 'undefined') lucide.createIcons();

                    populateStep2();
                    updateStepUI();
                    showToast('تم استعادة البيانات المحفوظة', 'success');
                }

                if (ss01Result?.rawData && ss01Result.rawData.length > 0) {
                    ss01Data = ss01Result.rawData;

                    // Load SS01 file date
                    const ss01DateResult = await loadFromIndexedDB('ss01FileDate');
                    ss01FileDate = ss01DateResult?.rawData ? new Date(ss01DateResult.rawData) : new Date();

                    const now = new Date();
                    const diff = now - ss01FileDate;
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                    let ageClass = 'age-normal';
                    if (days > 5) ageClass = 'age-critical';
                    else if (days > 2) ageClass = 'age-warning';

                    document.getElementById('ss01Box').classList.add('loaded');
                    document.getElementById('ss01Info').innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div><strong>[OK] تم استعادة بيانات القاعات</strong></div>
                            <button onclick="deleteReport('ss01')" title="حذف التقرير" 
                                    style="background:none; border:none; color:var(--accent-red); cursor:pointer; padding:4px;">
                                <i data-lucide="trash-2" style="width:16px; height:16px;"></i>
                            </button>
                        </div>
                        <div>تاريخ الملف: ${ss01FileDate.toLocaleDateString('ar-SA')}</div>
                        <div class="${ageClass}">عمر التقرير: ${days} يوم و ${hours} ساعة و ${minutes} دقيقة</div>
                        <div>عدد السجلات: ${ss01Data.length}</div>
                    `;
                    document.getElementById('ss01Info').classList.add('show');
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }

                // Restore course selection
                const courseResult = await loadFromIndexedDB('userCourseSelection');
                if (courseResult?.rawData) {
                    if (courseResult.rawData.department) {
                        selectedDepartment = courseResult.rawData.department;
                    }
                    if (courseResult.rawData.courses && courseResult.rawData.courses.length > 0) {
                        selectedCourses = courseResult.rawData.courses;
                    }
                }

                // Restore room data
                const roomResult = await loadFromIndexedDB('userRoomData');
                if (roomResult?.rawData) {
                    roomNames = roomResult.rawData.roomNames || [];
                    roomsWithBuilding = roomResult.rawData.roomsWithBuilding || [];
                    committeeRooms = roomResult.rawData.committeeRooms || [];
                    selectedBuildings = roomResult.rawData.selectedBuildings || [];
                    if (roomResult.rawData.committeeCount) {
                        committeeCount = roomResult.rawData.committeeCount;
                    }
                }

                // Restore committee settings
                const committeeSettingsResult = await loadFromIndexedDB('userCommitteeSettings');
                if (committeeSettingsResult?.rawData) {
                    if (committeeSettingsResult.rawData.committeeMode) {
                        committeeMode = committeeSettingsResult.rawData.committeeMode;
                    }
                    if (committeeSettingsResult.rawData.traineesPerCommittee) {
                        traineesPerCommittee = committeeSettingsResult.rawData.traineesPerCommittee;
                    }
                    if (committeeSettingsResult.rawData.committeeCount) {
                        committeeCount = committeeSettingsResult.rawData.committeeCount;
                    }
                }

            } catch (e) {
                console.log('No saved data to restore:', e);
            }
        }

        // Restore defaults - show modal with selectable options
        function restoreDefaults() {
            // Remove existing modal if any
            document.getElementById('restoreDefaultsModal')?.remove();

            const modal = document.createElement('div');
            modal.id = 'restoreDefaultsModal';
            modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:9999;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            modal.innerHTML = `
                <div style="background:var(--bg-card); border-radius:16px; padding:20px; max-width:520px; width:95%; border:1px solid var(--border-dark);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <h3 style="color:var(--accent-gold); margin:0; display:flex; align-items:center; gap:8px; font-size:16px;">
                            <i data-lucide="rotate-ccw" style="width:20px; height:20px;"></i>
                            استرجاع الافتراضي
                        </h3>
                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; color:var(--text-muted); font-size:12px;">
                            <input type="checkbox" id="toggleAllReset" checked 
                                   onchange="document.querySelectorAll('#restoreDefaultsModal .reset-option').forEach(c=>c.checked=this.checked)"
                                   style="width:16px; height:16px; accent-color:var(--accent-gold);">
                            تحديد الكل
                        </label>
                    </div>
                    <p style="color:var(--text-muted); font-size:12px; margin:0 0 15px;">
                        اختر البيانات المراد إعادة تعيينها. الملفات المرفوعة لن تتأثر.
                    </p>
                    
                    <div style="display:flex; flex-direction:column; gap:6px; margin-bottom:15px;">
                        <label style="display:flex; align-items:center; gap:10px; padding:8px 12px; background:var(--bg-header); border-radius:6px; cursor:pointer; border:1px solid var(--border-dark);">
                            <input type="checkbox" id="resetStatuses" class="reset-option" checked style="width:16px; height:16px; accent-color:var(--accent-gold);">
                            <span style="color:var(--text-light); font-size:13px;">تصنيف الحالات</span>
                            <span style="color:var(--text-muted); font-size:11px; margin-right:auto;">(الخطوة 2)</span>
                        </label>
                        
                        <label style="display:flex; align-items:center; gap:10px; padding:8px 12px; background:var(--bg-header); border-radius:6px; cursor:pointer; border:1px solid var(--border-dark);">
                            <input type="checkbox" id="resetCourses" class="reset-option" checked style="width:16px; height:16px; accent-color:var(--accent-gold);">
                            <span style="color:var(--text-light); font-size:13px;">اختيار المقررات</span>
                            <span style="color:var(--text-muted); font-size:11px; margin-right:auto;">(الخطوة 3)</span>
                        </label>
                        
                        <label style="display:flex; align-items:center; gap:10px; padding:8px 12px; background:var(--bg-header); border-radius:6px; cursor:pointer; border:1px solid var(--border-dark);">
                            <input type="checkbox" id="resetCommitteeSettings" class="reset-option" checked style="width:16px; height:16px; accent-color:var(--accent-gold);">
                            <span style="color:var(--text-light); font-size:13px;">إعدادات اللجان</span>
                            <span style="color:var(--text-muted); font-size:11px; margin-right:auto;">(الخطوة 4)</span>
                        </label>
                        
                        <label style="display:flex; align-items:center; gap:10px; padding:8px 12px; background:var(--bg-header); border-radius:6px; cursor:pointer; border:1px solid var(--border-dark);">
                            <input type="checkbox" id="resetRooms" class="reset-option" checked style="width:16px; height:16px; accent-color:var(--accent-gold);">
                            <span style="color:var(--text-light); font-size:13px;">القاعات والمباني</span>
                            <span style="color:var(--text-muted); font-size:11px; margin-right:auto;">(الخطوة 5)</span>
                        </label>
                        
                        <label style="display:flex; align-items:center; gap:10px; padding:8px 12px; background:var(--bg-header); border-radius:6px; cursor:pointer; border:1px solid var(--border-dark);">
                            <input type="checkbox" id="resetDistribution" class="reset-option" checked style="width:16px; height:16px; accent-color:var(--accent-gold);">
                            <span style="color:var(--text-light); font-size:13px;">توزيع المتدربين</span>
                            <span style="color:var(--text-muted); font-size:11px; margin-right:auto;">(الخطوة 5)</span>
                        </label>
                    </div>
                    
                    <div style="display:flex; gap:10px; justify-content:flex-end;">
                        <button onclick="document.getElementById('restoreDefaultsModal').remove()" 
                                style="padding:8px 18px; border-radius:6px; border:1px solid var(--border-dark); background:var(--bg-header); color:var(--text-light); cursor:pointer; font-family:inherit; font-size:13px;">
                            إلغاء
                        </button>
                        <button onclick="executeRestoreDefaults()" 
                                style="padding:8px 18px; border-radius:6px; border:none; background:linear-gradient(135deg, var(--accent-gold), #f59e0b); color:#000; cursor:pointer; font-family:inherit; font-weight:600; font-size:13px;">
                            تنفيذ
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function executeRestoreDefaults() {
            const resetStatuses = document.getElementById('resetStatuses')?.checked;
            const resetCourses = document.getElementById('resetCourses')?.checked;
            const resetCommitteeSettings = document.getElementById('resetCommitteeSettings')?.checked;
            const resetRooms = document.getElementById('resetRooms')?.checked;
            const resetDistribution = document.getElementById('resetDistribution')?.checked;

            if (!resetStatuses && !resetCourses && !resetCommitteeSettings && !resetRooms && !resetDistribution) {
                showToast('لم يتم اختيار أي بيانات للإعادة', 'warning');
                return;
            }

            // Close modal
            document.getElementById('restoreDefaultsModal')?.remove();

            // Clear status classifications
            if (resetStatuses) {
                includedStatuses = [];
                excludedStatuses = [];
                unknownStatuses = [];
                clearSavedData('userStatusClassifications');
            }

            // Clear course selection
            if (resetCourses) {
                selectedDepartment = null;
                selectedCourses = [];
                clearSavedData('userCourseSelection');
            }

            // Clear committee settings (count, mode)
            if (resetCommitteeSettings) {
                committeeCount = 1;
                committeeMode = 'trainees';
                step5LastCommitteeCount = 0;
            }

            // Clear room data (rooms, buildings, committeeRooms)
            if (resetRooms) {
                roomNames = [];
                roomsWithBuilding = [];
                selectedBuildings = [];
                committeeRooms = new Array(committeeCount).fill(null);
                clearSavedData('userRoomData');
            }

            // Clear distribution (committeeDistribution - names and counts)
            if (resetDistribution) {
                committeeDistribution = [];
            }

            // Reset to step 2 if we have data, otherwise step 1
            if (sf01Data) {
                currentStep = 2;
                maxReachedStep = 2;
                populateStep2();
            } else {
                currentStep = 1;
                maxReachedStep = 1;
            }
            updateStepUI();
            showToast('تم استرجاع الإعدادات المحددة', 'success');
        }

        // Initialize using shared utilities
        loadTheme();
        initDB().then(() => restoreData());

        // File Upload
        document.getElementById('sf01Input').addEventListener('change', (e) => handleFileUpload(e, 'sf01'));
        document.getElementById('ss01Input').addEventListener('change', (e) => handleFileUpload(e, 'ss01'));

        // Loading Overlay Functions
        function showLoading(message = 'جاري المعالجة...') {
            // Remove existing overlay if any
            document.getElementById('loadingOverlay')?.remove();

            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-spinner"></div>
                <div class="loading-text">${message}</div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            document.getElementById('loadingOverlay')?.remove();
        }

        // File Validation
        function validateFile(file, type) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedExtensions = ['.csv', '.xlsx', '.xls'];

            // Check file size
            if (file.size > maxSize) {
                showToast('حجم الملف كبير جداً (الحد الأقصى 10 ميجابايت)', 'error');
                return false;
            }

            // Check file extension
            const fileName = file.name.toLowerCase();
            const hasValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
            if (!hasValidExtension) {
                showToast('صيغة الملف غير مدعومة. يرجى استخدام CSV أو Excel', 'error');
                return false;
            }

            // Check if file is empty
            if (file.size === 0) {
                showToast('الملف فارغ', 'error');
                return false;
            }

            return true;
        }

        function handleFileUpload(e, type) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file first
            if (!validateFile(file, type)) {
                e.target.value = ''; // Reset input
                return;
            }

            const box = document.getElementById(type + 'Box');
            const info = document.getElementById(type + 'Info');
            const fileDate = new Date(file.lastModified);

            showLoading('جاري قراءة الملف...');

            const reader = new FileReader();
            reader.onload = (event) => {
                let data;
                if (file.name.endsWith('.csv')) {
                    data = parseCSV(event.target.result);
                } else {
                    hideLoading();
                    showToast('يرجى استخدام ملفات CSV حالياً', 'error');
                    return;
                }

                // Validate data has rows
                if (!data || data.length === 0) {
                    hideLoading();
                    showToast('الملف لا يحتوي على بيانات صالحة', 'error');
                    return;
                }

                hideLoading();

                if (type === 'sf01') {
                    sf01Data = data;
                    sf01FileDate = fileDate;
                    maxReachedStep = Math.max(maxReachedStep, 2);
                    // Save to IndexedDB using shared utils
                    saveToIndexedDB(data, 'sf01Data');
                    saveToIndexedDB(fileDate.toISOString(), 'sf01FileDate');
                } else {
                    ss01Data = data;
                    ss01FileDate = fileDate;
                    saveToIndexedDB(data, 'ss01Data');
                    saveToIndexedDB(fileDate.toISOString(), 'ss01FileDate');
                }

                box.classList.add('loaded');

                const now = new Date();
                const diff = now - fileDate;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                // Age-based color class
                let ageClass = 'age-normal';
                if (days > 5) ageClass = 'age-critical';
                else if (days > 2) ageClass = 'age-warning';

                info.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div><strong>[OK] ${file.name}</strong></div>
                        <button onclick="deleteReport('${type}')" title="حذف التقرير" 
                                style="background:none; border:none; color:var(--accent-red); cursor:pointer; padding:4px;">
                            <i data-lucide="trash-2" style="width:16px; height:16px;"></i>
                        </button>
                    </div>
                    <div>تاريخ الملف: ${fileDate.toLocaleDateString('ar-SA')}</div>
                    <div class="${ageClass}">عمر التقرير: ${days} يوم و ${hours} ساعة و ${minutes} دقيقة</div>
                    <div>عدد السجلات: ${data.length}</div>
                `;
                info.classList.add('show');
                if (typeof lucide !== 'undefined') lucide.createIcons();
                showToast('تم تحميل: ' + file.name, 'success');
                updateStepClickability();
            };
            reader.readAsText(file);
        }

        // Delete individual report
        function deleteReport(type) {
            if (type === 'sf01') {
                if (!confirm('هل أنت متأكد من حذف تقرير SF01؟\nسيتم إعادة تعيين جميع البيانات.')) return;

                sf01Data = null;
                sf01FileDate = null;
                selectedCourses = [];
                selectedDepartment = null;
                committeeDistribution = [];
                committeeRooms = [];
                roomsWithBuilding = [];
                roomNames = [];
                maxReachedStep = 1;
                currentStep = 1;

                // Clear from IndexedDB
                clearSavedData('sf01Data');
                clearSavedData('sf01FileDate');

                // Reset UI
                document.getElementById('sf01Box').classList.remove('loaded');
                document.getElementById('sf01Info').innerHTML = '';
                document.getElementById('sf01Info').classList.remove('show');
                document.getElementById('sf01Input').value = '';

                updateStepUI();
                showToast('تم حذف تقرير SF01', 'info');

            } else if (type === 'ss01') {
                if (!confirm('هل أنت متأكد من حذف تقرير SS01؟')) return;

                ss01Data = null;
                ss01FileDate = null;
                committeeRooms = [];
                roomsWithBuilding = [];
                roomNames = [];
                selectedBuildings = [];

                // Clear from IndexedDB
                clearSavedData('ss01Data');
                clearSavedData('ss01FileDate');

                // Reset UI
                document.getElementById('ss01Box').classList.remove('loaded');
                document.getElementById('ss01Info').innerHTML = '';
                document.getElementById('ss01Info').classList.remove('show');
                document.getElementById('ss01Input').value = '';

                showToast('تم حذف تقرير SS01', 'info');
            }

            updateStepClickability();
        }

        // Step Clickability
        function updateStepClickability() {
            document.querySelectorAll('.step').forEach((el, i) => {
                const stepNum = i + 1;
                if (stepNum <= maxReachedStep || (stepNum === currentStep + 1 && canProceed())) {
                    el.classList.add('clickable');
                } else {
                    el.classList.remove('clickable');
                }
            });
        }

        function canProceed() {
            if (currentStep === 1) return sf01Data !== null;
            if (currentStep === 2) {
                if (unknownStatuses.length > 0) {
                    showToast('يجب تصنيف جميع الحالات غير المعروفة أولاً', 'warning');
                    return false;
                }
                return sf01Data !== null;
            }
            if (currentStep === 3) return selectedCourses.length > 0;
            if (currentStep === 4) return committeeCount > 0;
            if (currentStep === 5) return true;
            if (currentStep === 6) return true;
            return true;
        }

        function updateStepClickability() {
            // Check if we can proceed to next step
            const canGoNext = canProceed();

            // Mark steps as clickable
            document.querySelectorAll('.step').forEach((el, i) => {
                const stepNum = i + 1;
                // Clickable if: already reached, OR is next step and can proceed
                if (stepNum <= maxReachedStep || (stepNum === currentStep + 1 && canGoNext)) {
                    el.classList.add('clickable');
                } else {
                    el.classList.remove('clickable');
                }
            });
        }

        function goToStep(step) {
            const stepEl = document.querySelector(`.step[data-step="${step}"]`);

            // Allow clicking if: already clickable, is current step, or is next step and can proceed
            const canClickNext = (step === currentStep + 1) && canProceed();
            if (!stepEl.classList.contains('clickable') && step !== currentStep && !canClickNext) {
                showToast('أكمل الخطوات السابقة أولاً', 'error');
                return;
            }

            if (step > currentStep) {
                while (currentStep < step) {
                    if (!canProceed()) break;
                    nextStep();
                }
            } else if (step < currentStep) {
                currentStep = step;
                updateStepUI();
            }
        }

        // Navigation
        function updateStepUI() {
            document.querySelectorAll('.step').forEach((el, i) => {
                el.classList.remove('active', 'completed');
                if (i + 1 === currentStep) el.classList.add('active');
                else if (i + 1 < currentStep) el.classList.add('completed');
            });

            document.querySelectorAll('.step-content').forEach((el, i) => {
                el.classList.toggle('active', i + 1 === currentStep);
            });

            document.getElementById('prevBtn').disabled = currentStep === 1;
            document.getElementById('nextBtn').textContent = currentStep === 6 ? 'إنهاء' : 'التالي ←';
            updateStepClickability();

            // Populate step-specific content
            if (currentStep === 4) populateStep4();

            // Scroll to top
            window.scrollTo(0, 0);
            document.querySelector('.wizard-content')?.scrollTo(0, 0);
        }

        function nextStep() {
            if (currentStep === 1 && !sf01Data) {
                showToast('يرجى رفع ملف SF01 أولاً', 'error');
                return;
            }
            if (currentStep === 2) populateStep3();
            if (currentStep === 3) {
                if (selectedCourses.length === 0) { showToast('يرجى اختيار مقرر واحد على الأقل', 'error'); return; }
                populateStep4();
            }
            if (currentStep === 4) {
                finalizeCommitteeCount();
                populateStep5();
            }
            if (currentStep === 5) generateReports();

            if (currentStep < 6) {
                currentStep++;
                maxReachedStep = Math.max(maxReachedStep, currentStep);
                if (currentStep === 2) populateStep2();
                updateStepUI();
            } else if (currentStep === 6) {
                // Show finish dialog
                showFinishDialog();
            }
        }

        function showFinishDialog() {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.id = 'finishDialog';
            overlay.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:9999;';

            // Close when clicking outside the dialog
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });

            overlay.innerHTML = `
                <div style="background:#1a1f2e; border-radius:16px; padding:40px; max-width:500px; width:90%; text-align:center; border:1px solid #2d3548; position:relative;">
                    <!-- Close button -->
                    <button onclick="document.getElementById('finishDialog').remove()" 
                        style="position:absolute; top:15px; left:15px; background:transparent; border:none; color:#9ca3af; font-size:24px; cursor:pointer; width:30px; height:30px; display:flex; align-items:center; justify-content:center;"
                        title="إغلاق">×</button>
                    
                    <p style="color:#f3f4f6; font-size:20px; font-weight:600; margin-bottom:30px;">ماذا تريد أن تفعل الآن؟</p>
                    <div style="display:flex; flex-direction:column; gap:15px;">
                        <button onclick="chooseAnotherCourse()" style="padding:15px 25px; border-radius:10px; border:2px solid #3b82f6; background:#3b82f6; color:white; font-size:16px; font-weight:600; cursor:pointer;">
                            اختيار مقرر آخر
                        </button>
                        <button onclick="closeApp()" style="padding:15px 25px; border-radius:10px; border:2px solid #3b82f6; background:transparent; color:#3b82f6; font-size:16px; font-weight:600; cursor:pointer;">
                            إنهاء التطبيق
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);
        }

        function chooseAnotherCourse() {
            // Remove dialog
            document.getElementById('finishDialog')?.remove();

            // Reset selection and go to step 3
            selectedCourses = [];
            committeeDistribution = []; // Reset distribution for new course
            currentStep = 3;
            populateStep3();
            updateStepUI();
            showToast('اختر مقرراً آخر', 'info');
        }

        function closeApp() {
            // Try to close the window
            window.close();
            // If window.close() doesn't work (some browsers block it)
            setTimeout(() => {
                document.getElementById('finishDialog')?.remove();
                showToast('لا يمكن إغلاق النافذة تلقائياً. يرجى إغلاقها يدوياً.', 'warning');
            }, 500);
        }

        function showAboutModal() {
            // Remove existing modal if any
            document.getElementById('aboutModal')?.remove();

            const modal = document.createElement('div');
            modal.id = 'aboutModal';
            modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:9999;';

            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            modal.innerHTML = `
                <div style="background:var(--bg-card); border-radius:20px; padding:30px; max-width:450px; width:90%; border:1px solid var(--border-dark); position:relative; text-align:center;">
                    <!-- Close button -->
                    <button onclick="document.getElementById('aboutModal').remove()" 
                        style="position:absolute; top:12px; left:12px; background:transparent; border:none; color:var(--text-muted); font-size:24px; cursor:pointer; width:30px; height:30px; display:flex; align-items:center; justify-content:center;"
                        title="إغلاق">×</button>
                    
                    <!-- App Icon -->
                    <div style="width:70px; height:70px; background:linear-gradient(135deg, var(--accent-gold), #f59e0b); border-radius:16px; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
                        <i data-lucide="clipboard-list" style="width:36px; height:36px; color:#000;"></i>
                    </div>
                    
                    <!-- App Name -->
                    <h2 style="color:var(--text-light); font-size:22px; font-weight:700; margin:0 0 5px;">توزيع المتدربين على اللجان</h2>
                    <p style="color:var(--accent-gold); font-size:13px; margin:0 0 20px;">الإصدار 2.0</p>
                    
                    <!-- Description -->
                    <p style="color:var(--text-muted); font-size:13px; line-height:1.7; margin:0 0 20px;">
                        أداة تساعد في توزيع المتدربين على لجان الاختبارات بشكل آلي ومنظم، مع إمكانية التحكم في عدد اللجان والقاعات وتصدير التقارير.
                    </p>
                    
                    <!-- Features -->
                    <div style="background:var(--bg-header); border-radius:12px; padding:15px; text-align:right; margin-bottom:20px;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px; color:var(--text-light); font-size:12px;">
                            <span style="color:var(--accent-green);">✓</span> دعم اختيار عدة مقررات في نفس الوقت
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px; color:var(--text-light); font-size:12px;">
                            <span style="color:var(--accent-green);">✓</span> توزيع تلقائي مع إمكانية التعديل اليدوي
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px; color:var(--text-light); font-size:12px;">
                            <span style="color:var(--accent-green);">✓</span> تصدير للطباعة و Excel
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; color:var(--text-light); font-size:12px;">
                            <span style="color:var(--accent-green);">✓</span> حفظ تلقائي للبيانات
                        </div>
                    </div>
                    
                    <!-- Developer -->
                    <div style="border-top:1px solid var(--border-dark); padding-top:15px;">
                        <p style="color:var(--text-muted); font-size:11px; margin:0;">تطوير</p>
                        <p style="color:var(--text-light); font-size:14px; font-weight:600; margin:5px 0 0;">م. محمد يوسف الشبيلي</p>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Reinitialize Lucide icons for the modal
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepUI();
            }
        }

        // Step 2: Departments and Status Filter
        function populateStep2() {
            const departments = [...new Set(sf01Data.map(r => r['القسم']).filter(Boolean))];
            const hasGeneralStudies = departments.some(d => d.includes('الدراسات العامة'));

            let alertHtml = '';
            if (!hasGeneralStudies) {
                alertHtml = `<div class="alert error">لم يتم تنزيل كامل التقرير SF01. قم بتنزيل التقرير من جديد مع التأكد من اختيار جميع الأقسام والتخصصات.</div>`;
            }
            document.getElementById('validationAlert').innerHTML = alertHtml;

            document.getElementById('departmentsList').innerHTML = departments.map(d =>
                `<span style="background:var(--bg-header); padding:5px 12px; border-radius:15px; font-size:12px;">${d}</span>`
            ).join('');

            // Populate status filter for all courses
            populateStatusFilterAll();
        }

        async function populateStatusFilterAll() {
            if (!sf01Data) return;

            allStatuses = {};

            sf01Data.forEach(t => {
                const status = t['حالة تسجيل'] || 'غير محدد';
                allStatuses[status] = (allStatuses[status] || 0) + 1;
            });

            // Classify statuses into 3 categories
            const statusNames = Object.keys(allStatuses);

            // Try to load saved classifications
            const savedClassifications = await loadFromIndexedDB('userStatusClassifications');
            const userIncluded = savedClassifications?.rawData?.included || [];
            const userExcluded = savedClassifications?.rawData?.excluded || [];

            // Merge: user classifications take priority, then defaults
            includedStatuses = statusNames.filter(s =>
                userIncluded.includes(s) ||
                (defaultIncludedStatuses.includes(s) && !userExcluded.includes(s))
            );
            excludedStatuses = statusNames.filter(s =>
                userExcluded.includes(s) ||
                (defaultExcludedStatuses.includes(s) && !userIncluded.includes(s))
            );
            unknownStatuses = statusNames.filter(s =>
                !includedStatuses.includes(s) && !excludedStatuses.includes(s)
            );

            renderStatusLists();
            updateStatusSummary();
        }

        // Save status classifications to IndexedDB
        function saveStatusClassifications() {
            saveToIndexedDB({
                included: includedStatuses,
                excluded: excludedStatuses
            }, 'userStatusClassifications');
        }

        // Step 3: Course Selection
        function populateStep3() {
            const departments = [...new Set(sf01Data.map(r => r['القسم']).filter(Boolean))];
            const container = document.getElementById('departmentButtons');

            // Calculate course count per department
            const deptCourseCounts = {};
            departments.forEach(dept => {
                const deptCourses = sf01Data.filter(r =>
                    r['القسم'] === dept &&
                    parseInt(r['الساعات المعتمدة'] || '0') > 0 &&
                    r['نوع الجدولة'] !== 'عملي صباحي'
                );
                // Count unique course+scheduleType combinations
                const uniqueCourses = new Set(deptCourses.map(r => `${r['المقرر']}|${r['نوع الجدولة']}`));
                deptCourseCounts[dept] = uniqueCourses.size;
            });

            container.innerHTML = departments.map(d => `
                <button class="dept-btn ${selectedDepartment === d ? 'active' : ''}" 
                        onclick="selectDepartment('${d}')"
                        style="padding: 12px 20px; border-radius: 10px; border: 1px solid var(--border-dark); 
                               background: ${selectedDepartment === d ? 'var(--accent-blue)' : 'var(--bg-card)'}; 
                               color: ${selectedDepartment === d ? '#fff' : 'var(--text-light)'}; 
                               cursor: pointer; font-family: inherit; font-size: 14px; font-weight: 600;
                               transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="building" style="width:16px; height:16px;"></i>
                    ${d}
                    <span style="background: ${selectedDepartment === d ? 'rgba(255,255,255,0.2)' : 'var(--accent-gold)'}; 
                                 color: ${selectedDepartment === d ? '#fff' : '#000'}; 
                                 padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 700;
                                 min-width: 24px; text-align: center;">${deptCourseCounts[d]}</span>
                </button>
            `).join('');

            // Reinitialize Lucide icons for new buttons
            if (typeof lucide !== 'undefined') lucide.createIcons();

            document.getElementById('courseFilter').oninput = renderCourses;

            // If department was already selected (persisted), render its courses
            if (selectedDepartment) {
                renderCourses();
                updateSelectedCoursesChipBar();
            }
        }

        function selectDepartment(dept) {
            selectedDepartment = dept;
            // Don't clear selectedCourses - keep them unless explicitly removed
            saveCourseSelection();
            populateStep3(); // Re-render buttons to show active state
            renderCourses();
            updateSelectedCoursesChipBar();
        }

        // Save course selection to IndexedDB
        function saveCourseSelection() {
            saveToIndexedDB({
                department: selectedDepartment,
                courses: selectedCourses
            }, 'userCourseSelection');
        }

        // Generate unique color for each schedule type based on string hash
        function getScheduleTypeColor(text) {
            let hash = 0;
            for (let i = 0; i < text.length; i++) {
                hash = text.charCodeAt(i) + ((hash << 5) - hash);
            }
            // Use HSL for vibrant colors with good contrast
            const hue = Math.abs(hash % 360);
            return `hsl(${hue}, 70%, 45%)`;
        }

        function renderCourses() {
            const filter = document.getElementById('courseFilter').value.toLowerCase();

            // Check if there are practical courses to show alert
            const hasPracticalCourses = sf01Data.some(r =>
                r['القسم'] === selectedDepartment && r['نوع الجدولة'] === 'عملي صباحي'
            );

            // Filter by department AND exclude courses with 0 credit hours AND exclude practical courses
            let filtered = sf01Data.filter(r =>
                r['القسم'] === selectedDepartment &&
                parseInt(r['الساعات المعتمدة'] || '0') > 0 &&
                r['نوع الجدولة'] !== 'عملي صباحي'
            );

            // Group by course code + schedule type (unique key)
            const courses = {};
            filtered.forEach(r => {
                const code = r['المقرر'] || '';
                const name = r['اسم المقرر'] || '';
                const scheduleType = r['نوع الجدولة'] || 'غير محدد';
                const status = r['حالة تسجيل'] || 'غير محدد';
                const key = `${code}|${scheduleType}`; // Unique key per course+scheduleType

                if (!courses[key]) courses[key] = { code, name, scheduleType, count: 0, totalCount: 0 };
                courses[key].totalCount++;

                // Only count if status is in included list
                if (includedStatuses.includes(status)) {
                    courses[key].count++;
                }
            });

            let courseList = Object.values(courses);

            // Filter by text search
            if (filter) {
                courseList = courseList.filter(c =>
                    c.code.toLowerCase().includes(filter) ||
                    c.name.toLowerCase().includes(filter) ||
                    c.scheduleType.toLowerCase().includes(filter)
                );
            }

            // Sort by code then schedule type
            courseList.sort((a, b) => a.code.localeCompare(b.code) || a.scheduleType.localeCompare(b.scheduleType));

            // Separate selected and unselected courses
            const selectedList = courseList.filter(c => selectedCourses.includes(`${c.code}|${c.scheduleType}`));
            const unselectedList = courseList.filter(c => !selectedCourses.includes(`${c.code}|${c.scheduleType}`));

            // Build HTML
            let html = '';

            // Practical courses note is now in the HTML header, no need to show warning here

            // Selected courses section (at top)
            if (selectedList.length > 0) {
                html += `
                    <div style="background:rgba(16, 185, 129, 0.1); border:1px solid var(--accent-green); border-radius:12px; padding:12px; margin-bottom:15px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <span style="color:var(--accent-green); font-weight:600; font-size:14px;">
                                ✓ المقررات المختارة (${selectedList.length})
                            </span>
                            ${selectedList.length > 1 ? `
                                <button onclick="clearAllSelectedCourses()" 
                                    style="background:rgba(239,68,68,0.15); color:#ef4444; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px; font-family:inherit; display:flex; align-items:center; gap:4px;">
                                    <span style="font-weight:700;">✕</span> إزالة الكل
                                </button>
                            ` : ''}
                        </div>
                        ${selectedList.map(c => {
                    const key = `${c.code}|${c.scheduleType}`;
                    return `
                            <div class="course-item selected" style="background:rgba(16, 185, 129, 0.15); border-color:var(--accent-green); margin-bottom:8px;" onclick="toggleCourse('${key}', ${c.count})">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <span style="color:var(--accent-green); font-size:18px;">✓</span>
                                    <span class="course-code">${c.code}</span> - 
                                    <span class="course-name">${c.name}</span>
                                    <span style="background:${getScheduleTypeColor(c.scheduleType)}; color:#fff; padding:2px 8px; border-radius:10px; font-size:10px;">${c.scheduleType}</span>
                                </div>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span class="course-count" style="color:var(--accent-gold); font-weight:700;">${c.count}</span>
                                    <span onclick="event.stopPropagation(); toggleCourse('${key}', ${c.count})" 
                                          style="background:rgba(239,68,68,0.2); color:#ef4444; padding:4px 8px; border-radius:4px; cursor:pointer; font-weight:700;">✕</span>
                                </div>
                            </div>`;
                }).join('')}
                    </div>
                `;
            }

            // Unselected courses section
            html += unselectedList.length ?
                unselectedList.map(c => {
                    const key = `${c.code}|${c.scheduleType}`;
                    return `
                    <div class="course-item" onclick="toggleCourse('${key}', ${c.count})">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <input type="checkbox" onclick="event.stopPropagation(); toggleCourse('${key}', ${c.count})" style="width:16px; height:16px;">
                            <span class="course-code">${c.code}</span> - 
                            <span class="course-name">${c.name}</span>
                            <span style="background:${getScheduleTypeColor(c.scheduleType)}; color:#fff; padding:2px 8px; border-radius:10px; font-size:10px;">${c.scheduleType}</span>
                        </div>
                        <span class="course-count">${c.count}${c.count !== c.totalCount ? ` <small style="opacity:0.6">(من ${c.totalCount})</small>` : ''}</span>
                    </div>
                `}).join('') : (selectedList.length === 0 ? '<div style="padding:20px; text-align:center; color:var(--text-muted);">لا توجد مقررات</div>' : '');

            document.getElementById('courseList').innerHTML = html;

            // Update selected count
            updateSelectedCoursesCount();
        }

        function updateSelectedCoursesCount() {
            // Calculate total trainees for selected courses
            let totalCount = 0;
            selectedCourses.forEach(key => {
                const [code, scheduleType] = key.split('|');
                const count = sf01Data.filter(r =>
                    r['المقرر'] === code &&
                    r['نوع الجدولة'] === scheduleType &&
                    includedStatuses.includes(r['حالة تسجيل'] || 'غير محدد')
                ).length;
                totalCount += count;
            });
            selectedCourseTraineeCount = totalCount;

            // Update step clickability based on new selection
            updateStepClickability();
        }

        function toggleCourse(key, count) {
            const idx = selectedCourses.indexOf(key);
            if (idx === -1) {
                selectedCourses.push(key);
            } else {
                selectedCourses.splice(idx, 1);
            }
            saveCourseSelection();
            renderCourses();
            updateSelectedCoursesChipBar();
        }

        function clearAllSelectedCourses() {
            selectedCourses = [];
            saveCourseSelection();
            renderCourses();
            updateSelectedCoursesChipBar();
        }

        function removeCourseFromSelection(key) {
            selectedCourses = selectedCourses.filter(k => k !== key);
            saveCourseSelection();
            renderCourses();
            updateSelectedCoursesChipBar();
        }

        function updateSelectedCoursesChipBar() {
            const chipBar = document.getElementById('selectedCoursesChipBar');
            const chipsContainer = document.getElementById('selectedCoursesChips');
            const countSpan = document.getElementById('selectedCoursesCount');
            const clearAllBtn = document.getElementById('clearAllCoursesBtn');

            if (!chipBar || !chipsContainer) return;

            if (selectedCourses.length === 0) {
                chipBar.style.display = 'none';
                return;
            }

            chipBar.style.display = 'block';
            countSpan.textContent = selectedCourses.length;
            clearAllBtn.style.display = selectedCourses.length > 1 ? 'inline-flex' : 'none';

            chipsContainer.innerHTML = selectedCourses.map(key => {
                const [code, scheduleType] = key.split('|');
                const course = sf01Data.find(r => r['المقرر'] === code);
                const name = course ? course['اسم المقرر'] : '';
                const courseCount = sf01Data.filter(r =>
                    r['المقرر'] === code &&
                    r['نوع الجدولة'] === scheduleType &&
                    includedStatuses.includes(r['حالة تسجيل'] || 'غير محدد')
                ).length;
                return `
                    <span style="background:var(--accent-green); color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; display:inline-flex; align-items:center; gap:6px;">
                        ${code} (${courseCount})
                        <span onclick="removeCourseFromSelection('${key}')" 
                              style="cursor:pointer; background:rgba(255,255,255,0.2); padding:2px 4px; border-radius:4px; font-weight:700;">✕</span>
                    </span>
                `;
            }).join('');

            // Reinitialize Lucide icons
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function selectCourse(code, count) {
            selectedCourse = code;
            selectedCourseTraineeCount = count;
            renderCourses();

            // Populate status filter
            populateStatusFilter();
        }

        function switchCommitteeMode(mode) {
            committeeMode = mode;
            document.getElementById('optionByRooms').classList.toggle('active', mode === 'rooms');
            document.getElementById('optionByTrainees').classList.toggle('active', mode === 'trainees');
            updateCommitteeCalc();
            saveCommitteeSettings();
        }

        // Populate Step 4 with persisted values
        function populateStep4() {
            // Set the input values from persisted data
            const traineesPerRoomInput = document.getElementById('traineesPerRoom');
            const committeeCountInput = document.getElementById('committeeCount');

            if (traineesPerRoomInput) {
                traineesPerRoomInput.value = traineesPerCommittee;
            }
            if (committeeCountInput && committeeCount > 0) {
                committeeCountInput.value = committeeCount;
            }

            // Set active mode
            document.getElementById('optionByRooms').classList.toggle('active', committeeMode === 'rooms');
            document.getElementById('optionByTrainees').classList.toggle('active', committeeMode === 'trainees');

            // Update calculations
            updateCommitteeCalc(true); // Skip save during initial population
        }

        function updateCommitteeCalc(skipSave = false) {
            const n = selectedCourseTraineeCount;

            if (committeeMode === 'rooms') {
                let rooms = parseInt(document.getElementById('committeeCount').value) || 0;
                // Enforce minimum of 1
                if (rooms < 1) {
                    rooms = 1;
                    document.getElementById('committeeCount').value = 1;
                }
                const perRoom = Math.ceil(n / rooms);
                document.getElementById('traineesPerRoomResult').textContent = `≈ ${perRoom} متدرب لكل لجنة`;
                document.getElementById('roomsNeededResult').textContent = '';

                // Update committeeCount for saving
                committeeCount = rooms;
            } else {
                let perRoom = parseInt(document.getElementById('traineesPerRoom').value) || 0;
                // Enforce minimum of 1
                if (perRoom < 1) {
                    perRoom = 1;
                    document.getElementById('traineesPerRoom').value = 1;
                }
                const rooms = Math.ceil(n / perRoom);
                document.getElementById('roomsNeededResult').textContent = `= ${rooms} لجنة مطلوبة`;
                document.getElementById('traineesPerRoomResult').textContent = '';

                // Update traineesPerCommittee for saving
                traineesPerCommittee = perRoom;
            }

            // Auto-save settings (unless skipped)
            if (!skipSave) {
                saveCommitteeSettings();
            }
        }

        function finalizeCommitteeCount() {
            if (committeeMode === 'rooms') {
                committeeCount = parseInt(document.getElementById('committeeCount').value) || 1;
            } else {
                traineesPerCommittee = parseInt(document.getElementById('traineesPerRoom').value) || 30;
                committeeCount = Math.ceil(selectedCourseTraineeCount / traineesPerCommittee);
            }
            // Reset distribution for new committee count
            committeeDistribution = [];
            // Save committee settings
            saveCommitteeSettings();
        }

        // Save committee settings to IndexedDB
        function saveCommitteeSettings() {
            saveToIndexedDB({
                committeeMode: committeeMode,
                traineesPerCommittee: traineesPerCommittee,
                committeeCount: committeeCount
            }, 'userCommitteeSettings');
        }

        // Status Filter Functions
        function populateStatusFilter() {
            if (!selectedCourse || !sf01Data) return;

            const courseTrainees = sf01Data.filter(r => r['المقرر'] === selectedCourse);
            allStatuses = {};

            courseTrainees.forEach(t => {
                const status = t['حالة تسجيل'] || 'غير محدد';
                allStatuses[status] = (allStatuses[status] || 0) + 1;
            });

            // Separate into included and excluded
            const statusNames = Object.keys(allStatuses);
            includedStatuses = statusNames.filter(s => defaultIncludedStatuses.includes(s));
            excludedStatuses = statusNames.filter(s => !defaultIncludedStatuses.includes(s));

            renderStatusLists();
            updateStatusSummary();
        }

        function renderStatusLists() {
            const includedContainer = document.getElementById('includedStatusesStep2');
            const excludedContainer = document.getElementById('excludedStatusesStep2');

            if (!includedContainer || !excludedContainer) return;

            includedContainer.innerHTML = includedStatuses.map(s => `
                <div class="status-item ${selectedStatusItem === s ? 'selected' : ''}" 
                     onclick="selectStatus('${s}', 'included')">
                    <span>${s}</span>
                    <span class="count">${allStatuses[s] || 0}</span>
                </div>
            `).join('') || '<div style="color:var(--text-muted);font-size:11px;text-align:center;padding:10px;">لا توجد حالات</div>';

            excludedContainer.innerHTML = excludedStatuses.map(s => `
                <div class="status-item ${selectedStatusItem === s ? 'selected' : ''}" 
                     onclick="selectStatus('${s}', 'excluded')">
                    <span>${s}</span>
                    <span class="count">${allStatuses[s] || 0}</span>
                </div>
            `).join('') || '<div style="color:var(--text-muted);font-size:11px;text-align:center;padding:10px;">لا توجد حالات</div>';

            // Render unknown statuses
            const unknownContainer = document.getElementById('unknownStatusesList');
            const unknownSection = document.getElementById('unknownStatusesSection');

            if (unknownContainer && unknownSection) {
                if (unknownStatuses.length > 0) {
                    unknownSection.style.display = 'block';
                    unknownContainer.innerHTML = unknownStatuses.map(s => `
                        <div class="status-item ${selectedStatusItem === s ? 'selected' : ''}" 
                             onclick="selectStatus('${s}', 'unknown')" style="border-right-color: #f59e0b;">
                            <span>${s}</span>
                            <span class="count">${allStatuses[s] || 0}</span>
                        </div>
                    `).join('');
                } else {
                    unknownSection.style.display = 'none';
                }
            }
        }

        function selectStatus(status, list) {
            selectedStatusItem = selectedStatusItem === status ? null : status;
            renderStatusLists();
        }

        // Classify selected unknown status as included
        function classifyUnknownAsIncluded() {
            if (!selectedStatusItem || !unknownStatuses.includes(selectedStatusItem)) {
                showToast('اختر حالة غير معروفة أولاً', 'error');
                return;
            }
            unknownStatuses = unknownStatuses.filter(s => s !== selectedStatusItem);
            includedStatuses.push(selectedStatusItem);
            selectedStatusItem = null;
            renderStatusLists();
            updateStatusSummary();
            saveStatusClassifications();
            showToast('تم إضافة الحالة للمسموحة', 'success');
        }

        // Classify selected unknown status as excluded
        function classifyUnknownAsExcluded() {
            if (!selectedStatusItem || !unknownStatuses.includes(selectedStatusItem)) {
                showToast('اختر حالة غير معروفة أولاً', 'error');
                return;
            }
            unknownStatuses = unknownStatuses.filter(s => s !== selectedStatusItem);
            excludedStatuses.push(selectedStatusItem);
            selectedStatusItem = null;
            renderStatusLists();
            updateStatusSummary();
            saveStatusClassifications();
            showToast('تم إضافة الحالة للمستبعدة', 'success');
        }

        function transferStatus(direction) {
            if (!selectedStatusItem) {
                showToast('اختر حالة أولاً', 'error');
                return;
            }

            if (direction === 'exclude') {
                if (includedStatuses.includes(selectedStatusItem)) {
                    includedStatuses = includedStatuses.filter(s => s !== selectedStatusItem);
                    excludedStatuses.push(selectedStatusItem);
                }
            } else {
                if (excludedStatuses.includes(selectedStatusItem)) {
                    excludedStatuses = excludedStatuses.filter(s => s !== selectedStatusItem);
                    includedStatuses.push(selectedStatusItem);
                }
            }

            selectedStatusItem = null;
            renderStatusLists();
            updateStatusSummary();
            saveStatusClassifications();
        }

        function updateStatusSummary() {
            const total = Object.values(allStatuses).reduce((a, b) => a + b, 0);
            const included = includedStatuses.reduce((sum, s) => sum + (allStatuses[s] || 0), 0);
            const excluded = excludedStatuses.reduce((sum, s) => sum + (allStatuses[s] || 0), 0);
            const unknown = unknownStatuses.reduce((sum, s) => sum + (allStatuses[s] || 0), 0);

            // Enhanced styled summary
            const styledEl = document.getElementById('statusSummaryStyled');
            if (styledEl) {
                styledEl.innerHTML = `
                    <div style="display:flex; justify-content:space-around; text-align:center; flex-wrap:wrap; gap:15px;">
                        <div style="padding:10px 20px;">
                            <div style="font-size:24px; font-weight:700; color:var(--text-light);">${total.toLocaleString()}</div>
                            <div style="font-size:14px; color:var(--text-muted);">إجمالي السجلات</div>
                        </div>
                        <div style="padding:10px 20px; background:rgba(16, 185, 129, 0.15); border-radius:10px;">
                            <div style="font-size:24px; font-weight:700; color:#10b981;">${included.toLocaleString()}</div>
                            <div style="font-size:12px; color:#10b981;">سيظهر في الكشوف</div>
                        </div>
                        <div style="padding:10px 20px; background:rgba(239, 68, 68, 0.15); border-radius:10px;">
                            <div style="font-size:24px; font-weight:700; color:#ef4444;">${excluded.toLocaleString()}</div>
                            <div style="font-size:12px; color:#ef4444;">مستبعد</div>
                        </div>
                        ${unknown > 0 ? `
                        <div style="padding:10px 20px; background:rgba(245, 158, 11, 0.15); border-radius:10px;">
                            <div style="font-size:24px; font-weight:700; color:#f59e0b;">${unknown.toLocaleString()}</div>
                            <div style="font-size:12px; color:#f59e0b;">غير مصنف</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            // Also update the small summary below status lists
            const summaryEl = document.getElementById('statusSummaryStep2');
            if (summaryEl) {
                summaryEl.innerHTML = unknown > 0
                    ? `<span style="color:#f59e0b; font-weight:600;">يوجد ${unknown} متدرب غير مصنف - يجب تصنيف الحالات قبل المتابعة</span>`
                    : '';
            }
        }

        function updateStatusFilter() {
            sortOrder = document.querySelector('input[name="sortOrder"]:checked')?.value || 'traineeId';
        }

        // Step 4: Committee Count (NEW)
        function populateStep4() {
            // Calculate total trainees for selected courses
            let totalTrainees = 0;
            selectedCourses.forEach(key => {
                const [code, scheduleType] = key.split('|');
                const count = sf01Data.filter(r =>
                    r['المقرر'] === code &&
                    r['نوع الجدولة'] === scheduleType &&
                    includedStatuses.includes(r['حالة تسجيل'] || 'غير محدد')
                ).length;
                totalTrainees += count;
            });
            selectedCourseTraineeCount = totalTrainees;

            // Show selected courses summary with trainee counts
            const summaryEl = document.getElementById('selectedCoursesSummary');
            const coursesList = selectedCourses.map(key => {
                const [code, scheduleType] = key.split('|');
                const course = sf01Data.find(r => r['المقرر'] === code);
                const name = course ? course['اسم المقرر'] : '';
                // Get count for this specific course
                const courseCount = sf01Data.filter(r =>
                    r['المقرر'] === code &&
                    r['نوع الجدولة'] === scheduleType &&
                    includedStatuses.includes(r['حالة تسجيل'] || 'غير محدد')
                ).length;
                const scheduleColor = getScheduleTypeColor(scheduleType);
                return `
                    <div style="background:var(--bg-header); border:1px solid var(--border-dark); padding:8px 12px; border-radius:8px; display:inline-flex; flex-direction:column; gap:4px;">
                        <div style="font-weight:600; color:var(--text-light);">${code} - ${name}</div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="background:${scheduleColor}; color:#fff; padding:2px 8px; border-radius:4px; font-size:11px;">${scheduleType}</span>
                            <span style="background:var(--accent-gold); color:#000; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:700;">${courseCount} متدرب</span>
                        </div>
                    </div>`;
            }).join('');

            summaryEl.innerHTML = `
                <div style="color:var(--text-light); margin-bottom:10px;">
                    <strong>المقررات المختارة:</strong>
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px;">
                    ${coursesList}
                </div>
                <div style="display:flex; justify-content:center; gap:20px; padding:15px; background:var(--bg-header); border-radius:10px;">
                    <div style="text-align:center;">
                        <div style="font-size:28px; font-weight:700; color:var(--accent-gold);">${totalTrainees}</div>
                        <div style="font-size:12px; color:var(--text-muted);">إجمالي المتدربين</div>
                    </div>
                </div>
            `;

            updateCommitteeCalc();

            // Reinitialize Lucide icons
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Track last committee count for step 5
        let step5LastCommitteeCount = 0;

        // Save room data to IndexedDB
        function saveRoomData() {
            saveToIndexedDB({
                roomNames,
                roomsWithBuilding,
                committeeRooms,
                selectedBuildings,
                committeeCount
            }, 'userRoomData');
        }

        // Clear all room data
        function clearAllRoomData() {
            if (!confirm('هل أنت متأكد من إزالة جميع القاعات المحفوظة؟')) return;
            roomNames = [];
            roomsWithBuilding = [];
            selectedBuildings = [];
            committeeRooms = new Array(committeeCount).fill(null);
            committeeDistribution = [];
            clearSavedData('userRoomData');
            populateStep5();
            showToast('تم إزالة جميع القاعات', 'info');
        }

        // Step 5: Room Distribution (was Step 4)
        function populateStep5() {
            const container = document.getElementById('roomSelectionMode');

            // Only reset if committeeCount changed AND no saved room data exists
            if (committeeCount !== step5LastCommitteeCount) {
                // Check if we have saved data to preserve
                if (roomsWithBuilding.length === 0) {
                    committeeRooms = new Array(committeeCount).fill(null);
                    committeeDistribution = [];
                } else {
                    // Adjust committeeRooms array size to match new committeeCount
                    if (committeeRooms.length < committeeCount) {
                        // Add null slots for new committees
                        while (committeeRooms.length < committeeCount) {
                            committeeRooms.push(null);
                        }
                    } else if (committeeRooms.length > committeeCount) {
                        // Trim excess slots
                        committeeRooms = committeeRooms.slice(0, committeeCount);
                    }
                }
                step5LastCommitteeCount = committeeCount;
            }

            if (ss01Data && ss01Data.length) {
                // Get buildings with room counts
                const buildingsData = {};
                ss01Data.forEach(r => {
                    const b = r['مبنى'];
                    if (b) {
                        if (!buildingsData[b]) buildingsData[b] = new Set();
                        if (r['قاعة']) buildingsData[b].add(r['قاعة']);
                    }
                });

                const buildings = Object.entries(buildingsData).map(([name, rooms]) => ({
                    name,
                    count: rooms.size,
                    colorIndex: Object.keys(buildingsData).indexOf(name) % buildingColors.length
                }));

                container.innerHTML = `
                    <!-- Main Title Banner -->
                    <div style="background:linear-gradient(135deg, rgba(251, 191, 36, 0.25), rgba(245, 158, 11, 0.25)); border:1px solid rgba(251, 191, 36, 0.5); border-radius:10px; padding:14px 18px; margin-bottom:12px; display:flex; align-items:center; justify-content:center; gap:10px;">
                        <i data-lucide="info" style="width:24px; height:24px; color:var(--accent-gold); flex-shrink:0;"></i>
                        <span style="font-size:16px; font-weight:700; color:var(--accent-gold);">طريقتان لإضافة القاعات</span>
                    </div>
                    
                    <!-- Method 1 Banner -->
                    <div style="background:rgba(251, 191, 36, 0.1); border:1px solid rgba(251, 191, 36, 0.3); border-radius:8px; padding:10px 15px; margin-bottom:15px; display:flex; align-items:center; gap:10px;">
                        <span style="background:var(--accent-gold); color:#000; padding:2px 8px; border-radius:4px; font-weight:700; font-size:12px;">1</span>
                        <span style="font-size:13px; color:var(--text-light);">الطريقة الأولى: اختر المبنى/المباني ثم اختر القاعات</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" style="display:flex; align-items:center; gap:8px;">
                            <i data-lucide="building" style="width:18px; height:18px;"></i> اختر المباني (يمكنك اختيار أكثر من مبنى):
                        </label>
                        <div class="buildings-container" id="buildingsContainer">
                            ${buildings.map((b, i) => `
                                <div class="building-card" data-building="${b.name}" data-color-index="${i % buildingColors.length}"
                                     onclick="toggleBuilding('${b.name}')"
                                     style="border-color: ${buildingColors[i % buildingColors.length]}30;">
                                    <div class="name">${b.name}</div>
                                    <div class="count">${b.count} قاعة</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="room-status" id="roomStatus" style="display:flex; justify-content:space-between; align-items:center;">
                        <span>تم اختيار: <span class="count" id="selectedCount">${roomsWithBuilding.length}</span> من <span class="count">${committeeCount}</span> قاعة</span>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span id="remainingText"></span>
                            ${roomsWithBuilding.length > 0 ? `
                                <button onclick="clearAllRoomData()" style="background:rgba(239,68,68,0.15); color:#ef4444; border:1px solid #ef4444; border-radius:6px; padding:4px 10px; cursor:pointer; font-size:12px; display:flex; align-items:center; gap:4px;">
                                    <i data-lucide="trash-2" style="width:14px; height:14px;"></i> مسح الكل
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ابحث في القاعات:</label>
                        <input type="text" class="form-input room-search" id="roomSearch" placeholder="اكتب للبحث..." oninput="filterRooms()">
                    </div>
                    
                    <div class="room-grid" id="roomGrid"></div>
                    
                    <div id="maxReachedAlert" class="alert info" style="display:none;">تم اختيار العدد المطلوب من القاعات (${committeeCount})</div>
                    
                    <!-- Method 2 Section - Styled with gold -->
                    <div style="margin-top:20px; padding-top:20px; border-top:2px dashed rgba(251, 191, 36, 0.3);">
                        <div onclick="toggleManualRoomSection()" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between; padding:12px 15px; background:linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2)); border:1px solid rgba(251, 191, 36, 0.5); border-radius:10px; margin-bottom:10px;">
                            <span style="color:var(--accent-gold); font-weight:600; display:flex; align-items:center; gap:10px;">
                                <span style="background:var(--accent-gold); color:#000; padding:2px 8px; border-radius:4px; font-weight:700; font-size:12px;">2</span>
                                <span style="font-size:14px;">الطريقة الثانية: إضافة قاعة يدوياً</span>
                            </span>
                            <i data-lucide="chevron-down" id="manualRoomChevron" style="width:18px; height:18px; color:var(--accent-gold); transition:transform 0.2s;"></i>
                        </div>
                        <div id="manualRoomSection" style="display:none; padding:15px; background:rgba(251, 191, 36, 0.1); border-radius:10px; border:1px solid rgba(251, 191, 36, 0.3);">
                            <div class="room-input-group" style="display:flex; gap:10px; margin-bottom:10px;">
                                <input type="text" class="form-input" id="manualRoomInput" placeholder="اكتب اسم القاعة واضغط Enter" style="flex:1; border-color:rgba(251, 191, 36, 0.4);">
                                <button class="nav-btn next" onclick="addManualRoomWithSS01()" style="padding:10px 20px;">إضافة</button>
                            </div>
                            <div class="room-chips" id="manualRoomChips" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
                        </div>
                    </div>
                `;

                if (typeof lucide !== 'undefined') lucide.createIcons();

                // Render any previously saved manual rooms and expand section if needed
                renderManualRoomChips();
                const manualRooms = roomsWithBuilding.filter(r => r.building === 'يدوي');
                if (manualRooms.length > 0) {
                    const section = document.getElementById('manualRoomSection');
                    const chevron = document.getElementById('manualRoomChevron');
                    if (section) section.style.display = 'block';
                    if (chevron) chevron.style.transform = 'rotate(180deg)';
                }
            } else {
                container.innerHTML = `
                    <div class="alert warning">لم يتم رفع ملف SS01 ليتم اختيار القاعات. يمكنك حالياً إدخال أسماء القاعات يدوياً، أو ستظهر أسماء اللجان كما هو موضح في جدول توزيع المتدربين على اللجان.</div>
                    <div class="room-status" style="display:flex; justify-content:space-between; align-items:center;">
                        <span>تم إدخال: <span class="count" id="manualCount">${roomNames.length}</span> من <span class="count">${committeeCount}</span> قاعة</span>
                        ${roomNames.length > 0 ? `
                            <button onclick="clearAllRoomData()" style="background:rgba(239,68,68,0.15); color:#ef4444; border:1px solid #ef4444; border-radius:6px; padding:4px 10px; cursor:pointer; font-size:12px; display:flex; align-items:center; gap:4px;">
                                <i data-lucide="trash-2" style="width:14px; height:14px;"></i> مسح الكل
                            </button>
                        ` : ''}
                    </div>
                    <div class="form-group">
                        <label class="form-label">أدخل أسماء القاعات:</label>
                        <div class="room-input-group">
                            <input type="text" class="form-input" id="roomInput" placeholder="اكتب اسم القاعة واضغط Enter">
                            <button class="nav-btn next" onclick="addRoom()" style="padding:10px 20px;">إضافة</button>
                        </div>
                        <div class="room-chips" id="roomChips"></div>
                    </div>
                    <div id="manualMaxAlert" class="alert info" style="display:none;">تم إدخال العدد المطلوب من القاعات</div>
                `;

                document.getElementById('roomInput').onkeypress = (e) => {
                    if (e.key === 'Enter') addRoom();
                };

                // Render any previously saved rooms
                renderRoomChips();
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            updateDistributionPreview();
        }

        function toggleBuilding(buildingName) {
            const card = document.querySelector(`.building-card[data-building="${buildingName}"]`);
            const colorIndex = parseInt(card.dataset.colorIndex);
            const color = buildingColors[colorIndex];

            if (selectedBuildings.includes(buildingName)) {
                // Deselect building
                selectedBuildings = selectedBuildings.filter(b => b !== buildingName);
                card.classList.remove('selected');
                card.style.background = '';
                card.style.borderColor = color + '30';

                // Remove rooms from this building
                roomsWithBuilding = roomsWithBuilding.filter(r => r.building !== buildingName);
                roomNames = roomsWithBuilding.map(r => r.room);
            } else {
                // Select building
                selectedBuildings.push(buildingName);
                card.classList.add('selected');
                card.style.background = color + '20';
                card.style.borderColor = color;
            }

            // Update rooms grid for all selected buildings
            updateRoomsFromSelectedBuildings();
            renderRoomGrid();
            updateDistributionPreview();
        }

        function updateRoomsFromSelectedBuildings() {
            allRoomsInBuilding = [];
            selectedBuildings.forEach((building, bIndex) => {
                const colorIndex = [...document.querySelectorAll('.building-card')].findIndex(c => c.dataset.building === building);
                const rooms = [...new Set(ss01Data.filter(r => r['مبنى'] === building).map(r => r['قاعة']).filter(Boolean))];
                rooms.forEach(room => {
                    if (!allRoomsInBuilding.some(r => r.room === room)) {
                        allRoomsInBuilding.push({
                            room,
                            building,
                            colorIndex: colorIndex % buildingColors.length
                        });
                    }
                });
            });
        }

        function renderRoomGrid() {
            const filter = (document.getElementById('roomSearch')?.value || '').toLowerCase();
            let rooms = allRoomsInBuilding;
            if (filter) rooms = rooms.filter(r => r.room.toLowerCase().includes(filter));

            const isMaxReached = roomsWithBuilding.length >= committeeCount;
            const gridEl = document.getElementById('roomGrid');
            if (!gridEl) return;

            gridEl.innerHTML = rooms.map(r => {
                const isSelected = roomsWithBuilding.some(rb => rb.room === r.room);
                const isDisabled = !isSelected && isMaxReached;
                const color = buildingColors[r.colorIndex];
                return `<label class="room-checkbox ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}" 
                               onclick="toggleRoom('${r.room}', '${r.building}', ${r.colorIndex}, event)"
                               style="border-right: 3px solid ${color};">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}> ${r.room}
                </label>`;
            }).join('');

            const countEl = document.getElementById('selectedCount');
            if (countEl) countEl.textContent = roomsWithBuilding.length;

            const remaining = committeeCount - roomsWithBuilding.length;
            const remainingEl = document.getElementById('remainingText');
            if (remainingEl) remainingEl.textContent = remaining > 0 ? `(متبقي: ${remaining})` : '';

            const alertEl = document.getElementById('maxReachedAlert');
            if (alertEl) alertEl.style.display = isMaxReached ? 'block' : 'none';
        }

        function filterRooms() {
            renderRoomGrid();
        }

        function toggleRoom(roomName, buildingName, colorIndex, e) {
            e.preventDefault();
            const roomObj = { room: roomName, building: buildingName, colorIndex };

            // Check if room is already assigned
            const existingCommitteeIndex = committeeRooms.findIndex(r => r && r.room === roomName);

            if (existingCommitteeIndex >= 0) {
                // Remove room from that committee
                committeeRooms[existingCommitteeIndex] = null;
                roomsWithBuilding = roomsWithBuilding.filter(r => r.room !== roomName);
            } else {
                // Find first empty slot
                let emptySlotIndex = committeeRooms.findIndex(r => r === null);
                if (emptySlotIndex === -1 && committeeRooms.length < committeeCount) {
                    emptySlotIndex = committeeRooms.length;
                }

                if (emptySlotIndex === -1) {
                    showToast(`تم الوصول للحد الأقصى (${committeeCount} قاعة)`, 'warning');
                    return;
                }

                // Add room to first empty slot
                committeeRooms[emptySlotIndex] = roomObj;
                roomsWithBuilding.push(roomObj);
            }

            roomNames = roomsWithBuilding.map(r => r.room);

            // Update hasRoom in committeeDistribution without resetting names
            updateCommitteeHasRoom();
            saveRoomData();

            renderRoomGrid();
            renderCommitteeTable();
        }

        // Update hasRoom status without resetting committee names
        function updateCommitteeHasRoom() {
            for (let i = 0; i < committeeDistribution.length; i++) {
                committeeDistribution[i].hasRoom = !!committeeRooms[i];
            }
        }

        // Drag and Drop functions
        let draggedIndex = null;

        function dragStart(e) {
            draggedIndex = parseInt(e.target.dataset.index);
            e.target.classList.add('dragging');
        }

        function dragOver(e) {
            e.preventDefault();
        }

        function drop(e) {
            e.preventDefault();
            const targetIndex = parseInt(e.target.closest('.sortable-room-item')?.dataset.index);
            if (targetIndex === undefined || targetIndex === draggedIndex) return;

            // Reorder array
            const [draggedItem] = roomsWithBuilding.splice(draggedIndex, 1);
            roomsWithBuilding.splice(targetIndex, 0, draggedItem);
            roomNames = roomsWithBuilding.map(r => r.room);

            committeeDistribution = []; // Reset distribution
            renderSortableRooms();
            updateDistributionPreview();
        }

        function dragEnd(e) {
            e.target.classList.remove('dragging');
            draggedIndex = null;
        }

        // Room-based drag and drop (drag only the room element, not the row)
        function dragStartRoom(e) {
            const roomItem = e.target.closest('.room-drag-item');
            if (!roomItem) return;
            draggedIndex = parseInt(roomItem.dataset.committeeIndex);
            roomItem.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        }

        function dragOverRoom(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function dropRoom(e) {
            e.preventDefault();
            const dropTarget = e.target.closest('.room-drag-item, .room-drop-zone');
            if (!dropTarget) return;

            const targetIndex = parseInt(dropTarget.dataset.committeeIndex);
            if (isNaN(targetIndex) || targetIndex === draggedIndex || draggedIndex === null) return;

            // Swap rooms in committeeRooms (the source has a room, target may or may not)
            const draggedRoom = committeeRooms[draggedIndex];
            const targetRoom = committeeRooms[targetIndex];

            if (!draggedRoom) return; // Can only drag rooms that exist

            // Swap rooms between positions
            committeeRooms[draggedIndex] = targetRoom; // May be null
            committeeRooms[targetIndex] = draggedRoom;

            // Update roomNames and roomsWithBuilding
            roomsWithBuilding = committeeRooms.filter(r => r !== null);
            roomNames = roomsWithBuilding.map(r => r.room);

            // Update hasRoom without resetting committee names
            updateCommitteeHasRoom();
            renderRoomGrid();
            renderCommitteeTable();

            draggedIndex = null;
        }

        function dragEndRoom(e) {
            const roomItem = e.target.closest('.room-drag-item');
            if (roomItem) roomItem.style.opacity = '1';
            draggedIndex = null;
        }

        function removeRoomFromCommittee(index) {
            if (committeeRooms[index]) {
                const removedRoom = committeeRooms[index];
                committeeRooms[index] = null;
                roomsWithBuilding = roomsWithBuilding.filter(r => r.room !== removedRoom.room);
                roomNames = roomsWithBuilding.map(r => r.room);

                updateCommitteeHasRoom();
                saveRoomData();
                renderRoomGrid();
                renderCommitteeTable();
            }
        }

        function removeSelectedRoom(index) {
            removeRoomFromCommittee(index);
        }

        function addRoom() {
            const input = document.getElementById('roomInput');
            const name = input.value.trim();

            if (roomNames.length >= committeeCount) {
                showToast(`تم الوصول للحد الأقصى (${committeeCount} قاعة)`, 'warning');
                return;
            }

            if (name && !roomNames.includes(name)) {
                const roomObj = { room: name, building: 'يدوي', colorIndex: 0 };
                roomNames.push(name);
                roomsWithBuilding.push(roomObj);

                // Also update committeeRooms - find first empty slot
                let emptySlotIndex = committeeRooms.findIndex(r => r === null);
                if (emptySlotIndex === -1 && committeeRooms.length < committeeCount) {
                    emptySlotIndex = committeeRooms.length;
                }
                if (emptySlotIndex >= 0) {
                    // Ensure committeeRooms array has enough slots
                    while (committeeRooms.length <= emptySlotIndex) {
                        committeeRooms.push(null);
                    }
                    committeeRooms[emptySlotIndex] = roomObj;
                }

                input.value = '';
                committeeDistribution = []; // Reset for new room
                saveRoomData();
                renderRoomChips();
                updateDistributionPreview();
            }
        }

        function removeRoom(name) {
            roomNames = roomNames.filter(r => r !== name);
            roomsWithBuilding = roomsWithBuilding.filter(r => r.room !== name);
            // Also remove from committeeRooms
            const idx = committeeRooms.findIndex(r => r && r.room === name);
            if (idx >= 0) committeeRooms[idx] = null;
            committeeDistribution = []; // Reset after removing room
            saveRoomData();
            renderRoomChips();
            updateDistributionPreview();
        }

        function renderRoomChips() {
            const chipsEl = document.getElementById('roomChips');
            if (chipsEl) {
                chipsEl.innerHTML = roomNames.map(r =>
                    `<div class="room-chip">${r} <span class="remove" onclick="removeRoom('${r}')">✕</span></div>`
                ).join('');
            }
            const countEl = document.getElementById('manualCount');
            if (countEl) countEl.textContent = roomNames.length;
            const alertEl = document.getElementById('manualMaxAlert');
            if (alertEl) alertEl.style.display = roomNames.length >= committeeCount ? 'block' : 'none';
        }

        // Toggle manual room section visibility (when SS01 is present)
        function toggleManualRoomSection() {
            const section = document.getElementById('manualRoomSection');
            const chevron = document.getElementById('manualRoomChevron');
            if (section && chevron) {
                const isOpen = section.style.display !== 'none';
                section.style.display = isOpen ? 'none' : 'block';
                chevron.style.transform = isOpen ? '' : 'rotate(180deg)';

                if (!isOpen) {
                    // Attach keypress listener when opened
                    const input = document.getElementById('manualRoomInput');
                    if (input) {
                        input.onkeypress = (e) => { if (e.key === 'Enter') addManualRoomWithSS01(); };
                    }
                }
            }
        }

        // Add manual room when SS01 file is present
        function addManualRoomWithSS01() {
            const input = document.getElementById('manualRoomInput');
            const name = input?.value?.trim();
            if (!name) return;

            if (roomsWithBuilding.length >= committeeCount) {
                showToast(`تم الوصول للحد الأقصى (${committeeCount} قاعة)`, 'warning');
                return;
            }

            if (roomsWithBuilding.some(r => r.room === name)) {
                showToast('هذه القاعة موجودة بالفعل', 'warning');
                return;
            }

            const roomObj = { room: name, building: 'يدوي', colorIndex: 9 }; // Use last color (purple) for manual
            roomsWithBuilding.push(roomObj);
            roomNames.push(name);

            // Find empty slot in committeeRooms
            let emptySlotIndex = committeeRooms.findIndex(r => r === null);
            if (emptySlotIndex === -1 && committeeRooms.length < committeeCount) {
                emptySlotIndex = committeeRooms.length;
            }
            if (emptySlotIndex >= 0) {
                while (committeeRooms.length <= emptySlotIndex) {
                    committeeRooms.push(null);
                }
                committeeRooms[emptySlotIndex] = roomObj;
            }

            input.value = '';
            saveRoomData();
            renderRoomGrid();
            renderManualRoomChips();
            renderCommitteeTable();
            showToast(`تم إضافة قاعة: ${name}`, 'success');
        }

        // Render chips for manually added rooms (when SS01 is present)
        function renderManualRoomChips() {
            const chipsEl = document.getElementById('manualRoomChips');
            if (!chipsEl) return;

            const manualRooms = roomsWithBuilding.filter(r => r.building === 'يدوي');
            chipsEl.innerHTML = manualRooms.map(r => `
                <div style="background:var(--accent-blue); color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; display:inline-flex; align-items:center; gap:6px;">
                    ${r.room}
                    <span onclick="removeRoom('${r.room}')" 
                          style="cursor:pointer; background:rgba(255,255,255,0.2); padding:2px 4px; border-radius:4px; font-weight:700;">✕</span>
                </div>
            `).join('');
        }

        function updateDistributionPreview() {
            // Calculate total trainees for selected courses
            let trainees = [];
            selectedCourses.forEach(key => {
                const [code, scheduleType] = key.split('|');
                const courseTrainees = sf01Data.filter(r =>
                    r['المقرر'] === code &&
                    r['نوع الجدولة'] === scheduleType &&
                    includedStatuses.includes(r['حالة تسجيل'] || 'غير محدد')
                );
                trainees = trainees.concat(courseTrainees);
            });

            // Fallback: if no trainees match filters, get all for selected courses
            if (trainees.length === 0) {
                selectedCourses.forEach(key => {
                    const [code, scheduleType] = key.split('|');
                    const courseTrainees = sf01Data.filter(r =>
                        r['المقرر'] === code &&
                        r['نوع الجدولة'] === scheduleType
                    );
                    trainees = trainees.concat(courseTrainees);
                });
            }

            totalTraineesCount = trainees.length;

            // Initialize or update committee distribution
            if (committeeDistribution.length === 0) {
                initCommitteeDistribution();
            }

            renderCommitteeTable();
        }

        function initCommitteeDistribution() {
            // Always use committeeCount
            const rooms = committeeCount;
            const n = totalTraineesCount;
            const base = Math.floor(n / rooms);
            const extra = n % rooms;

            // Initialize committeeRooms if needed (array of length committeeCount)
            if (committeeRooms.length !== rooms) {
                // Preserve existing rooms in order, pad with nulls
                const newCommitteeRooms = [];
                for (let i = 0; i < rooms; i++) {
                    newCommitteeRooms.push(committeeRooms[i] || roomsWithBuilding[i] || null);
                }
                committeeRooms = newCommitteeRooms;
            }

            // Preserve existing committee names and custom status if available
            const existingData = committeeDistribution.map(c => ({
                name: c.name,
                isNameCustom: c.isNameCustom || false
            }));

            committeeDistribution = [];
            for (let i = 0; i < rooms; i++) {
                const count = base + (i < extra ? 1 : 0);
                // Keep existing name and custom status or use default
                const name = existingData[i]?.name || `لجنة ${i + 1}`;
                const isNameCustom = existingData[i]?.isNameCustom || false;
                const hasRoom = !!committeeRooms[i];
                committeeDistribution.push({ name, count, locked: false, hasRoom, isNameCustom });
            }
        }

        function renderCommitteeTable() {
            const currentTotal = committeeDistribution.reduce((sum, c) => sum + c.count, 0);
            const isBalanced = currentTotal === totalTraineesCount;
            const diff = totalTraineesCount - currentTotal;

            let html = `
                <div style="display:flex; align-items:center; justify-content:space-between; margin-top:20px; margin-bottom:10px;">
                    <h3 style="color:var(--text-light); margin:0; display:flex; align-items:center; gap:8px;">
                        <i data-lucide="settings-2" style="width:20px; height:20px;"></i> توزيع المتدربين على اللجان
                    </h3>
                    <div style="display:flex; gap:8px;">
                        <button onclick="resetDistribution()" 
                            title="إعادة ضبط: إعادة تسمية اللجان غير المعدلة يدوياً + توزيع متساوي من البداية"
                            style="background:var(--bg-header); border:1px solid var(--border-dark); color:var(--text-light); padding:6px 12px; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:6px; font-size:12px;">
                            <i data-lucide="refresh-ccw" style="width:14px; height:14px;"></i> إعادة ضبط
                        </button>
                        <button onclick="autoBalance()" 
                            title="تسوية تلقائية: نستخدمها عند إضافة/حذف شعبة حيث يتم إعادة توزيع الفائض/الناقص على اللجان غير المقفلة فقط. مثال: إذا بقي 5 متدربين يوزعهم على اللجان المفتوحة"
                            style="background:var(--bg-card); border:1px solid var(--accent-gold); color:var(--accent-gold); padding:6px 12px; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:6px; font-size:12px;">
                            <i data-lucide="scale" style="width:14px; height:14px;"></i> تسوية تلقائية
                        </button>
                    </div>
                </div>
                <table class="committee-dist-table">
                    <thead>
                        <tr>
                            <th style="width:10%;">#</th>
                            <th style="width:25%;">القاعة</th>
                            <th style="width:25%;">اللجنة</th>
                            <th style="width:15%;">المتدربين</th>
                            <th style="width:10%;">قفل</th>
                            <th style="width:15%;">حذف</th>
                        </tr>
                    </thead>
                    <tbody>`;

            committeeDistribution.forEach((c, i) => {
                const isWarning = c.count === 0;
                const isPending = !c.hasRoom;
                const rowClass = isWarning ? 'warning-row' : (isPending ? 'committee-pending' : '');
                const lockIcon = c.locked ? 'lock' : 'lock-open';
                const lockClass = c.locked ? 'locked' : '';

                // Get room info from committeeRooms (not roomsWithBuilding)
                const roomInfo = committeeRooms[i];
                const roomColor = roomInfo ? buildingColors[roomInfo.colorIndex] : '#666';
                const roomName = roomInfo ? roomInfo.room : '';
                const roomBuilding = roomInfo ? roomInfo.building : '';

                html += `
                    <tr class="${rowClass}" data-index="${i}">
                        <td style="font-weight:600; color:var(--accent-gold);">${i + 1}</td>
                        <td>
                            ${roomInfo ? `
                                <div class="room-drag-item" draggable="true" data-committee-index="${i}"
                                     ondragstart="dragStartRoom(event)" ondragover="dragOverRoom(event)" 
                                     ondrop="dropRoom(event)" ondragend="dragEndRoom(event)"
                                     style="display:flex; align-items:center; gap:6px; padding:6px; background:var(--bg-header); border-radius:6px; border-right:3px solid ${roomColor}; cursor:grab;">
                                    <span class="drag-handle" style="color:var(--text-muted);">
                                        <i data-lucide="grip-vertical" style="width:14px; height:14px;"></i>
                                    </span>
                                    <span style="width:8px; height:8px; border-radius:50%; background:${roomColor};"></span>
                                    <span style="flex:1;"><strong>${roomName}</strong></span>
                                    <button class="remove-btn" onclick="removeRoomFromCommittee(${i})" title="إزالة القاعة"
                                            style="background:none; border:none; color:var(--accent-red); cursor:pointer; padding:2px;">
                                        <i data-lucide="x" style="width:14px; height:14px;"></i>
                                    </button>
                                </div>
                                <div style="font-size:10px; color:var(--text-muted); margin-right:20px; margin-top:2px;">${roomBuilding}</div>
                            ` : `
                                <div class="room-drop-zone" data-committee-index="${i}"
                                     ondragover="dragOverRoom(event)" ondrop="dropRoom(event)"
                                     style="padding:10px; text-align:center; border:2px dashed var(--border-dark); border-radius:6px;">
                                    <span style="color:#f59e0b;">⚠️ لم تُحدد</span>
                                </div>
                            `}
                        </td>
                        <td>
                            <input type="text" class="committee-name-input ${c.isNameCustom ? 'custom-name' : ''}" value="${c.name}" 
                                   style="background:transparent; border:1px solid ${c.isNameCustom ? 'var(--accent-gold)' : 'var(--border-dark)'}; border-radius:6px; padding:4px 8px; color:var(--text-light); font-size:12px; width:100%;"
                                   onchange="updateCommitteeName(${i}, this.value)">
                        </td>
                        <td>
                            <input type="number" class="count-input" value="${c.count}" min="0" 
                                   onchange="updateCommitteeCount(${i}, parseInt(this.value) || 0)">
                        </td>
                        <td>
                            <button class="action-btn lock-btn ${lockClass}" onclick="toggleCommitteeLock(${i})" 
                                    title="${c.locked ? 'فتح القفل' : 'قفل'}">
                                <i data-lucide="${lockIcon}" style="width:18px; height:18px;"></i>
                            </button>
                        </td>
                        <td>
                            <button class="action-btn delete-btn" onclick="deleteCommittee(${i})" title="حذف اللجنة">
                                <i data-lucide="x" style="width:18px; height:18px;"></i>
                            </button>
                        </td>
                    </tr>`;
            });

            // Add committee button row
            html += `
                <tr class="add-committee-row">
                    <td colspan="6" style="text-align:center; padding:12px;">
                        <button onclick="addCommittee()" class="add-committee-btn" title="إضافة لجنة جديدة"
                                style="background:var(--bg-header); border:2px dashed var(--accent-gold); border-radius:10px; 
                                       padding:10px 20px; color:var(--accent-gold); cursor:pointer; font-family:inherit;
                                       font-size:14px; display:inline-flex; align-items:center; gap:8px; transition:all 0.2s;">
                            <i data-lucide="plus-circle" style="width:20px; height:20px;"></i>
                            إضافة لجنة
                        </button>
                    </td>
                </tr>`;

            html += `</tbody></table>`;

            // Total bar
            const barClass = isBalanced ? 'balanced' : 'unbalanced';
            const statusIcon = isBalanced ? 'check-circle' : 'alert-circle';
            const diffText = diff > 0 ? `(ناقص ${diff})` : (diff < 0 ? `(زائد ${Math.abs(diff)})` : '');

            html += `
                <div class="total-bar ${barClass}">
                    <i data-lucide="${statusIcon}" style="width:20px; height:20px;"></i>
                    <span>المجموع: ${currentTotal} / ${totalTraineesCount} ${diffText}</span>
                </div>`;

            document.getElementById('distributionPreview').innerHTML = html;

            // Reinitialize Lucide icons
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // Render distribution chart
            renderDistributionChart();
        }

        // Chart instance reference
        let distributionChartInstance = null;

        function renderDistributionChart() {
            const chartContainer = document.getElementById('chartContainer');
            const canvas = document.getElementById('distributionChart');

            if (!chartContainer || !canvas || committeeDistribution.length === 0) {
                if (chartContainer) chartContainer.style.display = 'none';
                return;
            }

            // Show chart container
            chartContainer.style.display = 'block';

            // Prepare chart data
            const labels = committeeDistribution.map(c => c.name);
            const data = committeeDistribution.map(c => c.count);
            const averageCount = totalTraineesCount / committeeDistribution.length;

            // Generate colors based on count (green if at average, gradient otherwise)
            const backgroundColors = data.map(count => {
                if (count === 0) return 'rgba(239, 68, 68, 0.7)'; // Red for empty
                if (count >= averageCount - 1 && count <= averageCount + 1) return 'rgba(16, 185, 129, 0.7)'; // Green for balanced
                return 'rgba(251, 191, 36, 0.7)'; // Gold for others
            });

            const borderColors = data.map(count => {
                if (count === 0) return 'rgba(239, 68, 68, 1)';
                if (count >= averageCount - 1 && count <= averageCount + 1) return 'rgba(16, 185, 129, 1)';
                return 'rgba(251, 191, 36, 1)';
            });

            // Destroy existing chart if any
            if (distributionChartInstance) {
                distributionChartInstance.destroy();
            }

            // Create new chart
            const ctx = canvas.getContext('2d');
            distributionChartInstance = new Chart(ctx, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'عدد المتدربين',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        borderRadius: 6,
                        barThickness: 'flex',
                        maxBarThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            rtl: true,
                            textDirection: 'rtl',
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleFont: { family: 'Cairo', size: 14 },
                            bodyFont: { family: 'Cairo', size: 13 },
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function (context) {
                                    const percentage = ((context.raw / totalTraineesCount) * 100).toFixed(1);
                                    return `${context.raw} متدرب (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'start',
                            offset: 4,
                            textAlign: 'center',
                            color: '#ffffff',
                            font: {
                                family: 'Cairo',
                                size: 14,
                                weight: 'bold'
                            },
                            formatter: function (value) {
                                return value;
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 30
                        }
                    },
                    scales: {
                        y: {
                            display: false,
                            beginAtZero: true,
                            grace: '15%'
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#94a3b8',
                                font: { family: 'Cairo', size: 11 },
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    },
                    animation: {
                        duration: 500,
                        easing: 'easeOutQuart'
                    }
                }
            });

            // Reinitialize Lucide icons in chart container
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function updateCommitteeCount(index, newCount) {
            if (index >= 0 && index < committeeDistribution.length) {
                committeeDistribution[index].count = Math.max(0, newCount);
                renderCommitteeTable();
            }
        }

        function updateCommitteeName(index, newName) {
            if (index >= 0 && index < committeeDistribution.length) {
                const trimmedName = newName.trim();
                const defaultName = `لجنة ${index + 1}`;

                // Check if name is different from default
                if (trimmedName && trimmedName !== defaultName) {
                    committeeDistribution[index].name = trimmedName;
                    committeeDistribution[index].isNameCustom = true;
                } else {
                    committeeDistribution[index].name = defaultName;
                    committeeDistribution[index].isNameCustom = false;
                }
                renderCommitteeTable();
            }
        }

        function toggleCommitteeLock(index) {
            if (index >= 0 && index < committeeDistribution.length) {
                committeeDistribution[index].locked = !committeeDistribution[index].locked;
                renderCommitteeTable();
            }
        }

        function addCommittee() {
            // Add new committee
            committeeCount++;
            step5LastCommitteeCount = committeeCount;

            // Add new committeeRoom slot (null = no room assigned)
            committeeRooms.push(null);

            // Add new committee to distribution
            const newCommittee = {
                name: `لجنة ${committeeCount}`,
                count: 0,
                locked: false,
                hasRoom: false,
                isNameCustom: false
            };
            committeeDistribution.push(newCommittee);

            // Redistribute trainees among unlocked committees
            redistributeTrainees();

            renderRoomGrid();
            renderCommitteeTable();
            showToast('تم إضافة لجنة جديدة', 'success');
        }

        function redistributeTrainees() {
            // Get locked committees and their total
            let lockedTotal = 0;
            let unlockedCount = 0;

            committeeDistribution.forEach(c => {
                if (c.locked) {
                    lockedTotal += c.count;
                } else {
                    unlockedCount++;
                }
            });

            // Calculate remaining trainees for unlocked committees
            const remainingTrainees = totalTraineesCount - lockedTotal;

            if (unlockedCount === 0 || remainingTrainees < 0) return;

            // Distribute remaining trainees evenly among unlocked
            const base = Math.floor(remainingTrainees / unlockedCount);
            let extra = remainingTrainees % unlockedCount;

            committeeDistribution.forEach(c => {
                if (!c.locked) {
                    c.count = base + (extra > 0 ? 1 : 0);
                    if (extra > 0) extra--;
                }
            });
        }

        function deleteCommittee(index) {
            if (committeeDistribution.length <= 1) {
                showToast('لا يمكن حذف اللجنة الوحيدة', 'error');
                return;
            }

            const deletedCount = committeeDistribution[index].count;
            committeeDistribution.splice(index, 1);

            // Distribute deleted count to unlocked committees
            if (deletedCount > 0) {
                const unlocked = committeeDistribution.filter(c => !c.locked);
                if (unlocked.length > 0) {
                    const perCommittee = Math.floor(deletedCount / unlocked.length);
                    let remainder = deletedCount % unlocked.length;

                    unlocked.forEach(c => {
                        c.count += perCommittee;
                        if (remainder > 0) {
                            c.count++;
                            remainder--;
                        }
                    });
                }
            }

            // Update committeeCount
            committeeCount = committeeDistribution.length;
            renderCommitteeTable();
        }

        function autoBalance() {
            const currentTotal = committeeDistribution.reduce((sum, c) => sum + c.count, 0);
            const diff = totalTraineesCount - currentTotal;

            if (diff === 0) {
                showToast('التوزيع متوازن بالفعل', 'info');
                return;
            }

            const unlocked = committeeDistribution.filter(c => !c.locked);
            if (unlocked.length === 0) {
                showToast('جميع اللجان مقفلة - افتح واحدة على الأقل للتسوية', 'warning');
                return;
            }

            const perCommittee = Math.floor(Math.abs(diff) / unlocked.length);
            let remainder = Math.abs(diff) % unlocked.length;
            const sign = diff > 0 ? 1 : -1;

            unlocked.forEach(c => {
                c.count += sign * perCommittee;
                if (remainder > 0) {
                    c.count += sign;
                    remainder--;
                }
                // Ensure non-negative
                c.count = Math.max(0, c.count);
            });

            renderCommitteeTable();
            showToast('تم تسوية التوزيع تلقائياً', 'success');
        }

        function resetDistribution() {
            const rooms = committeeCount;
            const n = totalTraineesCount;
            const base = Math.floor(n / rooms);
            const extra = n % rooms;

            // Reset distribution but keep custom names
            for (let i = 0; i < committeeDistribution.length; i++) {
                // Reset count
                committeeDistribution[i].count = base + (i < extra ? 1 : 0);
                committeeDistribution[i].locked = false;

                // Reset name only if not custom
                if (!committeeDistribution[i].isNameCustom) {
                    committeeDistribution[i].name = `لجنة ${i + 1}`;
                }
            }

            renderCommitteeTable();
            showToast('تم إعادة ضبط التوزيع المتساوي', 'success');
        }

        // Step 5: Generate Reports
        function generateReports() {
            try {
                // Filter by selected courses and included statuses
                let trainees = [];
                selectedCourses.forEach(key => {
                    const [code, scheduleType] = key.split('|');
                    const courseTrainees = sf01Data.filter(r =>
                        r['المقرر'] === code &&
                        r['نوع الجدولة'] === scheduleType &&
                        includedStatuses.includes(r['حالة تسجيل'] || 'غير محدد')
                    );
                    trainees = trainees.concat(courseTrainees);
                });

                // Fallback: if no trainees match, use all trainees for selected courses
                if (trainees.length === 0) {
                    selectedCourses.forEach(key => {
                        const [code, scheduleType] = key.split('|');
                        const courseTrainees = sf01Data.filter(r =>
                            r['المقرر'] === code &&
                            r['نوع الجدولة'] === scheduleType
                        );
                        trainees = trainees.concat(courseTrainees);
                    });
                }

                // Apply sort order
                const currentSortOrder = document.querySelector('input[name="sortOrder"]:checked')?.value || 'traineeId';

                if (currentSortOrder === 'traineeId') {
                    trainees.sort((a, b) => (a['رقم المتدرب'] || '').localeCompare(b['رقم المتدرب'] || ''));
                } else if (currentSortOrder === 'referenceNumber') {
                    trainees.sort((a, b) => (a['الرقم المرجعي'] || '').localeCompare(b['الرقم المرجعي'] || ''));
                } else if (currentSortOrder === 'instructor') {
                    trainees.sort((a, b) => (a['المدرب'] || '').localeCompare(b['المدرب'] || ''));
                } else if (currentSortOrder === 'traineeName') {
                    trainees.sort((a, b) => (a['إسم المتدرب'] || a['اسم المتدرب'] || '').localeCompare(b['إسم المتدرب'] || b['اسم المتدرب'] || ''));
                }

                // Get course names for header
                const courseNames = selectedCourses.map(key => {
                    const [code] = key.split('|');
                    const course = sf01Data.find(r => r['المقرر'] === code);
                    return course ? `${code} - ${course['اسم المقرر']}` : code;
                }).join(' | ');

                const collegeName = trainees[0] ? (trainees[0]['الوحدة'] || '') : '';
                const semester = trainees[0] ? (trainees[0]['الفصل التدريبي'] || '') : '';

                // Use committeeDistribution for customized distribution
                // Filter out committees with 0 trainees (cancelled), keep original index
                const activeCommittees = committeeDistribution
                    .map((c, idx) => ({ ...c, originalIndex: idx }))
                    .filter(c => c.count > 0);

                if (activeCommittees.length === 0) {
                    showToast('جميع اللجان فارغة. أعد توزيع المتدربين.', 'error');
                    return;
                }

                let html = '';
                let start = 0;

                for (let i = 0; i < activeCommittees.length; i++) {
                    const committee = activeCommittees[i];
                    const size = committee.count;
                    const roomName = committee.name;
                    // Get room number from committeeRooms using original index
                    const roomNumber = committeeRooms[committee.originalIndex]?.room || '';
                    const group = trainees.slice(start, start + size);
                    const firstId = group[0] ? group[0]['رقم المتدرب'] : '-';
                    const lastId = group[group.length - 1] ? group[group.length - 1]['رقم المتدرب'] : '-';

                    // Dynamic header info based on sort type
                    let rangeLabel, rangeValue;
                    if (currentSortOrder === 'traineeId') {
                        rangeLabel = 'نطاق الأرقام';
                        rangeValue = `${firstId} - ${lastId}`;
                    } else if (currentSortOrder === 'referenceNumber') {
                        const firstRef = group[0] ? group[0]['الرقم المرجعي'] : '-';
                        const lastRef = group[group.length - 1] ? group[group.length - 1]['الرقم المرجعي'] : '-';
                        const uniqueRefs = [...new Set(group.map(t => t['الرقم المرجعي'] || '-'))];
                        rangeLabel = 'الأرقام المرجعية';
                        rangeValue = uniqueRefs.length <= 3 ? uniqueRefs.join(' / ') : `${firstRef} - ${lastRef}`;
                    } else if (currentSortOrder === 'instructor') {
                        const instructors = [...new Set(group.map(t => t['المدرب'] || 'غير محدد'))];
                        rangeLabel = 'المدربون';
                        rangeValue = instructors.join(' / ');
                    } else { // traineeName
                        const firstLetter = (group[0] ? (group[0]['إسم المتدرب'] || group[0]['اسم المتدرب'] || '')[0] : '');
                        const lastLetter = (group[group.length - 1] ? (group[group.length - 1]['إسم المتدرب'] || group[group.length - 1]['اسم المتدرب'] || '')[0] : '');
                        rangeLabel = 'نطاق الأحرف';
                        rangeValue = firstLetter === lastLetter ? firstLetter : `${firstLetter} - ${lastLetter}`;
                    }



                    // Split committee into pages based on traineesPerPage
                    // If traineesPerPage is empty or <= 0, treat as Infinity (all in one page)
                    let perPageInput = document.getElementById('traineesPerPage').value;
                    let perPage = (perPageInput && perPageInput > 0) ? parseInt(perPageInput) : (group.length || 1);

                    const totalPages = Math.ceil(group.length / perPage);

                    // Extract College and Semester from the first record of the group (or global data if available)
                    // Fallback to defaults if missing
                    const sampleRecord = group[0] || (sf01Data && sf01Data.length > 0 ? sf01Data[0] : {});
                    const collegeName = sampleRecord['الوحدة'] || 'الكلية التقنية';
                    const semester = sampleRecord['الفصل التدريبي'] || '';

                    for (let pageNum = 0; pageNum < totalPages; pageNum++) {
                        const pageStart = pageNum * perPage;
                        const pageEnd = Math.min(pageStart + perPage, group.length);
                        const pageGroup = group.slice(pageStart, pageEnd);
                        const pageLabel = totalPages > 1 ? ` (صفحة ${pageNum + 1} من ${totalPages})` : '';

                        html += `
                    <div class="report-page">
                        <div class="report-section">
                            <table class="report-table" style="table-layout: fixed; width: 100%; margin-top: 10px;">
                                <colgroup>
                                    <col style="width: 4%;">
                                    <col style="width: 11%;">
                                    <col style="width: 22%;">
                                    <col style="width: 18%;">
                                    <col style="width: 9%;">
                                    <col style="width: 20%;">
                                    <col style="width: 16%;">
                                </colgroup>
                                <thead>
                                    <tr class="header-row" style="background-color: #fff !important;">
                                        <th colspan="7" style="background-color: #fff !important; border:none; padding:0;">
                                            
                                            <div class="report-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #ccc; padding: 10px; direction: rtl; background: #fff;">
                                                
                                                <!-- Right Side (Institution Info) -->
                                                <div style="width: 30%; text-align: center; font-weight: bold; font-family: 'Amiri', 'Tajawal', sans-serif; font-size: 14px; line-height: 1.6;">
                                                    <div style="white-space:nowrap; font-size:12px;">المملكة العربية السعودية</div>
                                                    <div style="white-space:nowrap; font-size:12px;">المؤسسة العامة للتدريب التقني والمهني</div>
                                                    <div>${collegeName}</div>
                                                    <div>${semester}</div>
                                                </div>

                                                <!-- Center (Logo Only) -->
                                                <div style="width: 30%; text-align: center;">
                                                    <img src="pic/logo.png" alt="Logo" style="max-height: 100px; width: auto;">
                                                </div>

                                                <!-- Left Side (Committee Info) -->
                                                <div style="width: 35%; text-align: center; font-weight: bold; font-family: 'Amiri', 'Tajawal', sans-serif; font-size: 14px; line-height: 1.6;">
                                                    <div style="margin-bottom: 2px; font-size: 20px; font-weight:bold;">${roomName}</div>
                                                    ${roomNumber ? `<div style="margin-bottom: 2px; font-size: 18px; font-weight:bold; color:#444;">قاعة: ${roomNumber}</div>` : ''}
                                                    <div>عدد المتدربين: <span style="font-weight:normal;">${group.length}</span></div>
                                                </div>
                                            </div>

                                        </th>
                                    </tr>
                                    <tr style="background-color: #ABD8AE;">
                                        <th style="background-color: #ABD8AE !important;">#</th>
                                        <th style="background-color: #ABD8AE !important;">رقم المتدرب</th>
                                        <th style="background-color: #ABD8AE !important;">اسم المتدرب</th>
                                        <th style="background-color: #ABD8AE !important;">اسم المقرر</th>
                                        <th style="background-color: #ABD8AE !important;">الرقم المرجعي</th>
                                        <th style="background-color: #ABD8AE !important;">المدرب</th>
                                        <th style="background-color: #ABD8AE !important;">توقيع المتدرب</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pageGroup.map((t, idx) => `
                                        <tr>
                                            <td style="overflow: hidden !important;">${pageStart + idx + 1}</td>
                                            <td style="overflow: hidden !important;">${t['رقم المتدرب'] || ''}</td>
                                            <td style="overflow: hidden !important;">${t['إسم المتدرب'] || t['اسم المتدرب'] || ''}</td>
                                            <td style="overflow: hidden !important;">${t['اسم المقرر'] || ''}</td>
                                            <td style="overflow: hidden !important;">${t['الرقم المرجعي'] || ''}</td>
                                            <td style="overflow: hidden !important;">${t['المدرب'] || ''}</td>
                                            <td></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                </tbody>
                                ${document.getElementById('showSignatureFooter')?.checked ? `
                                <tfoot>
                                    <tr>
                                        <td colspan="7" style="border: none; padding-top: 20px;">
                                            <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; table-layout: fixed;">
                                                <colgroup>
                                                    <col style="width: 33.33%;">
                                                    <col style="width: 33.33%;">
                                                    <col style="width: 33.34%;">
                                                </colgroup>
                                                <tr>
                                                    <td style="width: 33.33%; border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold; font-size: 11px;">المراقب الأول:</td>
                                                    <td style="width: 33.33%; border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold; font-size: 11px;">المراقب الثاني:</td>
                                                    <td style="width: 33.33%; border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold; font-size: 11px;">رئيس اللجنة:</td>
                                                </tr>
                                                <tr>
                                                    <td style="width: 33.33%; height: 40px; border: 1px solid #000; padding: 8px; text-align: right; font-size: 11px;">التوقيع:</td>
                                                    <td style="width: 33.33%; height: 40px; border: 1px solid #000; padding: 8px; text-align: right; font-size: 11px;">التوقيع:</td>
                                                    <td style="width: 33.33%; height: 40px; border: 1px solid #000; padding: 8px; text-align: right; font-size: 11px;">التوقيع:</td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </tfoot>
                                ` : ''}
                            </table>
                        </div>
                    </div>
                `;
                    }
                    start += size;
                }

                document.getElementById('reportsContainer').innerHTML = html;

                // Auto-fit text in table cells
                // Auto-fit text in table cells
                setTimeout(() => {
                    const cells = document.querySelectorAll('.report-table td');
                    cells.forEach(cell => {
                        let size = 12; // Start with requested size
                        cell.style.fontSize = size + 'px';

                        // Decrease size until content fits vertically (max 45px height)
                        // Allow 1px tolerance
                        while (cell.scrollHeight > cell.clientHeight + 1 && size > 8) {
                            size -= 0.5;
                            cell.style.fontSize = size + 'px';
                        }
                    });
                }, 100);



            } catch (e) {
                console.error('Error generating reports:', e);
                showToast('حدث خطأ في إنشاء التقارير', 'error');
            }
        }

        function printReports() {
            // Set page title to include course names
            const courseNames = selectedCourses.map(key => {
                const [code] = key.split('|');
                const course = sf01Data.find(r => r['المقرر'] === code);
                return course ? course['اسم المقرر'] : code;
            }).join(' | ');
            document.title = `توزيع المتدربين - ${courseNames || 'لجان الاختبارات'}`;

            window.print();
        }

        function updateFontSize() {
            const size = document.getElementById('fontSizeSlider').value;
            document.getElementById('fontSizeValue').textContent = size + 'pt';

            // Apply to all report tables
            document.querySelectorAll('.report-table').forEach(table => {
                table.style.fontSize = size + 'pt';
            });
            document.querySelectorAll('.report-table th, .report-table td').forEach(cell => {
                cell.style.fontSize = size + 'pt';
            });
            document.querySelectorAll('.report-header h2').forEach(h2 => {
                h2.style.fontSize = (parseInt(size) + 4) + 'pt';
            });
            document.querySelectorAll('.report-header .info').forEach(info => {
                info.style.fontSize = size + 'pt';
            });
        }

        function updateTraineesPerPage() {
            const value = parseInt(document.getElementById('traineesPerPage').value);
            if (value >= 5 && value <= 50) {
                traineesPerPage = value;
                generateReports(); // Regenerate reports with new pagination
            }
        }

        let currentBaseFontSize = 12; // Base font size, updated by density slider

        function autoFitText() {
            const cells = document.querySelectorAll('.report-table td');
            cells.forEach(cell => {
                let size = currentBaseFontSize; // Start with the density-appropriate size
                cell.style.fontSize = size + 'px';

                // Decrease size until content fits vertically (max based on current height)
                // We compare scrollHeight (full content) vs clientHeight (fixed height)
                // Allow 1px tolerance
                while (cell.scrollHeight > cell.clientHeight + 1 && size > 5) {
                    size -= 0.5;
                    cell.style.fontSize = size + 'px';
                }
            });
        }

        // Initialize with default level
        setTimeout(() => setRowHeight(3), 200);

        function setRowHeight(level) {
            const labelEl = document.getElementById('rowHeightLabel');

            // Update active state in UI
            document.querySelectorAll('.row-height-circle').forEach(circle => {
                circle.classList.remove('active');
                circle.style.background = 'var(--bg-header)';
                circle.style.borderColor = 'var(--border-dark)';
                if (parseInt(circle.dataset.level) === level) {
                    circle.classList.add('active');
                    circle.style.background = 'var(--accent-green)';
                    circle.style.borderColor = 'var(--accent-green)';
                }
            });

            // Map levels to height values (px) AND base font sizes AND padding
            const configMap = {
                1: { height: 35, fontSize: 10, padding: '2px', label: 'صغير جداً' },
                2: { height: 40, fontSize: 11, padding: '3px', label: 'صغير' },
                3: { height: 45, fontSize: 12, padding: '4px', label: 'متوسط' },
                4: { height: 50, fontSize: 12, padding: '6px', label: 'كبير' },
                5: { height: 55, fontSize: 12, padding: '8px', label: 'كبير جداً' }
            };

            const config = configMap[level] || configMap[3];
            if (labelEl) labelEl.textContent = config.label;

            // Update global base font size
            currentBaseFontSize = config.fontSize;

            // Set CSS variable
            document.documentElement.style.setProperty('--print-row-height', config.height + 'px');

            // FORCE inline styles on all cells to ensure print rendering respects it
            // This bypasses potential CSS specificity or variable caching issues in print
            const cells = document.querySelectorAll('.report-table td');
            cells.forEach(cell => {
                cell.style.height = config.height + 'px';
                cell.style.padding = config.padding;
                // Ensure line-height allows tight packing
                cell.style.lineHeight = (config.fontSize * 1.2) + 'px';
            });

            // Trigger auto-fit after a brief delay to allow CSS calculation
            setTimeout(() => {
                autoFitText();
            }, 50);
        }





        function exportToExcel() {
            // Check if reports exist
            const reportPages = document.querySelectorAll('.report-page');
            if (reportPages.length === 0) {
                showToast('لا توجد تقارير للتصدير. تأكد من إنشاء التقارير أولاً.', 'warning');
                return;
            }

            showToast('جاري تحميل مكتبة Excel...', 'info');

            // Get course info from selected courses
            const courseNames = selectedCourses.map(key => {
                const [code] = key.split('|');
                const course = sf01Data.find(r => r['المقرر'] === code);
                return course ? `${code} - ${course['اسم المقرر']}` : code;
            }).join(' | ');

            const firstCourse = selectedCourses.length > 0 ? selectedCourses[0].split('|')[0] : '';
            const courseData = sf01Data.find(r => r['المقرر'] === firstCourse);
            const collegeName = courseData?.['الوحدة'] || '';
            const semester = courseData?.['الفصل التدريبي'] || '';
            const totalTrainees = document.querySelectorAll('.report-page .report-table tbody tr').length;

            // Create a temporary consolidated table from all report tables
            const tempTable = document.createElement('table');
            tempTable.id = 'tempExportTable';
            tempTable.style.display = 'none';

            // New header structure (without courses and total count):
            // Row 0: Title (colspan 6) | Logo area (colspan 2)
            // Row 1: College label | College value (colspan 5) | Logo area
            // Row 2: Semester label | Semester value (colspan 5) | Logo area
            // Row 3: Committee label | Committee value (colspan 5) | Logo area
            // Row 4: Room label | Room value (colspan 5) | (empty)
            // Row 5: Empty separator row
            // Row 6: Column headers

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr><th colspan="8">توزيع المتدربين على لجان الاختبارات</th></tr>
                <tr><td>الكلية / الوحدة:</td><td colspan="5">${collegeName}</td><td colspan="2" data-logo="true"></td></tr>
                <tr><td>الفصل التدريبي:</td><td colspan="5">${semester}</td><td colspan="2" data-logo="true"></td></tr>
                <tr><td>اسم اللجنة:</td><td colspan="5" data-committee-name="true"></td><td colspan="2" data-logo="true"></td></tr>
                <tr><td>رقم القاعة:</td><td colspan="5" data-room-number="true"></td><td colspan="2"></td></tr>
                <tr><td colspan="8"></td></tr>
                <tr>
                    <th>اللجنة</th>
                    <th>#</th>
                    <th>رقم المتدرب</th>
                    <th>اسم المتدرب</th>
                    <th>اسم المقرر</th>
                    <th>الرقم المرجعي</th>
                    <th>المدرب</th>
                    <th>توقيع المتدرب</th>
                </tr>
            `;
            tempTable.appendChild(thead);

            // Add data from all report tables
            const tbody = document.createElement('tbody');
            let rowCount = 0;

            reportPages.forEach((page, pageIdx) => {
                // Extract room name and remove page suffix like "(صفحة 1 من 2)"
                let roomName = page.querySelector('.report-header h2')?.textContent?.replace('لجنة / قاعة:', '').trim() || `لجنة ${pageIdx + 1}`;
                roomName = roomName.replace(/\s*\(صفحة\s*\d+\s*من\s*\d+\)/, '').trim();
                const rows = page.querySelectorAll('.report-table tbody tr');

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 7) {
                        const newRow = document.createElement('tr');
                        newRow.innerHTML = `
                            <td>${roomName}</td>
                            <td>${cells[0]?.textContent || ''}</td>
                            <td>${cells[1]?.textContent || ''}</td>
                            <td>${cells[2]?.textContent || ''}</td>
                            <td>${cells[3]?.textContent || ''}</td>
                            <td>${cells[4]?.textContent || ''}</td>
                            <td>${cells[5]?.textContent || ''}</td>
                            <td> </td>
                        `;
                        tbody.appendChild(newRow);
                        rowCount++;
                    }
                });
            });
            tempTable.appendChild(tbody);

            if (rowCount === 0) {
                showToast('لا توجد بيانات للتصدير.', 'warning');
                return;
            }

            document.body.appendChild(tempTable);

            // Load XLSX library and export
            if (typeof XLSX === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js';
                script.onload = () => {
                    generateExcelFromTable(tempTable, courseNames);
                };
                script.onerror = () => {
                    showToast('فشل تحميل مكتبة Excel. تحقق من اتصال الإنترنت.', 'error');
                    document.body.removeChild(tempTable);
                };
                document.head.appendChild(script);
            } else {
                generateExcelFromTable(tempTable, courseNames);
            }
        }

        function generateExcelFromTable(table, courseNames) {
            try {
                // Group data by committee
                const committees = new Map(); // Map: committeeName -> [rows]
                const headerRows = []; // First 7 rows (title, info, headers)

                const allRows = table.querySelectorAll('tr');
                allRows.forEach((row, rowIndex) => {
                    const cells = row.querySelectorAll('th, td');
                    const rowData = [];
                    for (let i = 0; i < 8; i++) {
                        const cellText = cells[i]?.textContent?.trim() || ' ';
                        rowData.push(cellText === '' ? ' ' : cellText);
                    }

                    if (rowIndex <= 6) {
                        // Header rows (title, info, column headers)
                        headerRows.push(rowData);
                    } else {
                        // Data row - group by committee (column 0)
                        const committeeName = rowData[0];
                        if (!committees.has(committeeName)) {
                            committees.set(committeeName, []);
                        }
                        committees.get(committeeName).push(rowData);
                    }
                });

                // Define styles
                const thinBorder = {
                    top: { style: 'thin', color: { rgb: '333333' } },
                    bottom: { style: 'thin', color: { rgb: '333333' } },
                    left: { style: 'thin', color: { rgb: '333333' } },
                    right: { style: 'thin', color: { rgb: '333333' } }
                };

                const titleStyle = {
                    fill: { fgColor: { rgb: 'D4A017' } },
                    font: { color: { rgb: 'FFFFFF' }, bold: true, sz: 14 },
                    alignment: { horizontal: 'center', vertical: 'center' },
                    border: thinBorder
                };

                const infoStyle = (isLabel) => ({
                    fill: { fgColor: { rgb: isLabel ? 'E5E7EB' : 'FFFFFF' } },
                    font: { sz: 11, bold: isLabel },
                    alignment: { horizontal: 'right', vertical: 'center' },
                    border: thinBorder
                });

                const headerStyle = {
                    fill: { fgColor: { rgb: '1E3A5F' } },
                    font: { color: { rgb: 'FFFFFF' }, bold: true, sz: 11 },
                    alignment: { horizontal: 'center', vertical: 'center' },
                    border: thinBorder
                };

                const dataStyle = (isEven) => ({
                    fill: { fgColor: { rgb: isEven ? 'F9FAFB' : 'FFFFFF' } },
                    font: { sz: 10 },
                    alignment: { horizontal: 'center', vertical: 'center' },
                    border: thinBorder
                });

                // Create workbook
                const wb = XLSX.utils.book_new();
                wb.Workbook = { Views: [{ RTL: true }] };

                // Create a sheet for each committee
                let sheetIndex = 0;
                committees.forEach((rows, committeeName) => {
                    sheetIndex++;

                    // Clone header rows and customize for this committee
                    const customHeaderRows = headerRows.map((row, rowIdx) => {
                        const newRow = [...row];
                        if (rowIdx === 3) {
                            // Row 3: اسم اللجنة - fill with committee name
                            newRow[1] = committeeName;
                        } else if (rowIdx === 4) {
                            // Row 4: رقم القاعة - find room number for this committee
                            const committeeIdx = committeeDistribution.findIndex(c => c.name === committeeName);
                            const roomObj = committeeIdx >= 0 ? committeeRooms[committeeIdx] : null;
                            newRow[1] = roomObj?.room || '';
                        }
                        return newRow;
                    });

                    // Build sheet data: customized headers + committee rows
                    const sheetData = [...customHeaderRows, ...rows];

                    // Add signature section at end
                    const dataEndRow = sheetData.length;

                    // 2 empty rows
                    sheetData.push(['', '', '', '', '', '', '', '']);
                    sheetData.push(['', '', '', '', '', '', '', '']);

                    // 1 empty row (no borders - spacer)
                    sheetData.push(['', '', '', '', '', '', '', '']);

                    // Signature labels row (merged: cols 0-2 (3), 3-4 (2), 5-7 (3))
                    sheetData.push(['المراقب الأول:', '', '', 'المراقب الثاني:', '', 'رئيس اللجنة:', '', '']);

                    // Signature row (التوقيع) with same structure
                    sheetData.push(['التوقيع:', '', '', 'التوقيع:', '', 'التوقيع:', '', '']);

                    const ws = XLSX.utils.aoa_to_sheet(sheetData);

                    // Signature row styles
                    const signatureLabelStyle = {
                        font: { bold: true, sz: 11 },
                        alignment: { horizontal: 'right', vertical: 'center' },
                        border: thinBorder
                    };

                    const signatureEmptyStyle = {
                        border: thinBorder,
                        alignment: { horizontal: 'right', vertical: 'center' }
                    };

                    const noBorderStyle = {
                        fill: { fgColor: { rgb: 'FFFFFF' } }
                    };

                    // Apply styles
                    for (let R = 0; R < sheetData.length; R++) {
                        for (let C = 0; C < 8; C++) {
                            const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
                            if (!ws[cellRef]) ws[cellRef] = { v: ' ', t: 's' };

                            if (R === 0) {
                                ws[cellRef].s = titleStyle;
                            } else if (R >= 1 && R <= 4) {
                                ws[cellRef].s = infoStyle(C === 0);
                            } else if (R === 5) {
                                ws[cellRef].s = { fill: { fgColor: { rgb: 'FFFFFF' } } };
                            } else if (R === 6) {
                                ws[cellRef].s = headerStyle;
                            } else if (R < dataEndRow) {
                                ws[cellRef].s = dataStyle((R - 6) % 2 === 0);
                            } else if (R === dataEndRow + 2) {
                                // Spacer row - no borders
                                ws[cellRef].s = noBorderStyle;
                            } else if (R === dataEndRow + 3) {
                                // Signature labels
                                ws[cellRef].s = signatureLabelStyle;
                            } else if (R === dataEndRow + 4) {
                                // Empty signature row
                                ws[cellRef].s = signatureEmptyStyle;
                            }
                        }
                    }

                    // Column widths
                    ws['!cols'] = [
                        { wch: 18 }, { wch: 5 }, { wch: 12 }, { wch: 30 },
                        { wch: 20 }, { wch: 10 }, { wch: 28 }, { wch: 15 }
                    ];

                    // Merge header cells + signature cells
                    ws['!merges'] = [
                        { s: { r: 0, c: 0 }, e: { r: 0, c: 7 } },
                        { s: { r: 1, c: 1 }, e: { r: 1, c: 7 } },
                        { s: { r: 2, c: 1 }, e: { r: 2, c: 7 } },
                        { s: { r: 3, c: 1 }, e: { r: 3, c: 7 } },
                        { s: { r: 4, c: 1 }, e: { r: 4, c: 7 } },
                        { s: { r: 5, c: 0 }, e: { r: 5, c: 7 } },
                        // Signature label merges (3-2-3 columns)
                        { s: { r: dataEndRow + 3, c: 0 }, e: { r: dataEndRow + 3, c: 2 } },  // المراقب الأول (3 cols)
                        { s: { r: dataEndRow + 3, c: 3 }, e: { r: dataEndRow + 3, c: 4 } },  // المراقب الثاني (2 cols)
                        { s: { r: dataEndRow + 3, c: 5 }, e: { r: dataEndRow + 3, c: 7 } },  // رئيس اللجنة (3 cols)
                        // Signature row merges (التوقيع) - same structure
                        { s: { r: dataEndRow + 4, c: 0 }, e: { r: dataEndRow + 4, c: 2 } },
                        { s: { r: dataEndRow + 4, c: 3 }, e: { r: dataEndRow + 4, c: 4 } },
                        { s: { r: dataEndRow + 4, c: 5 }, e: { r: dataEndRow + 4, c: 7 } }
                    ];

                    // Sheet name (max 31 chars, clean invalid chars)
                    let sheetName = committeeName.substring(0, 28).replace(/[\\/*?:\[\]]/g, '');
                    if (sheetName.trim() === '') sheetName = `لجنة ${sheetIndex}`;

                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });

                // Export file
                const fileNameBase = courseNames.length > 50 ? 'توزيع_المتدربين' : `توزيع_${courseNames.replace(/[|\/\\:*?"<>]/g, '_').substring(0, 50)}`;
                XLSX.writeFile(wb, `${fileNameBase}.xlsx`);

                showToast(`تم تصدير ${committees.size} لجنة في ملف Excel`, 'success');
            } catch (err) {
                console.error('Excel export error:', err);
                showToast('حدث خطأ في التصدير: ' + err.message, 'error');
            } finally {
                document.body.removeChild(table);
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger navigation when typing in input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            // For RTL: Left arrow = next (forward), Right arrow = previous (back)
            if (e.key === 'ArrowLeft') nextStep();
            if (e.key === 'ArrowRight') previousStep();
            if (e.ctrlKey && e.key === 'p') { e.preventDefault(); window.print(); }
        });

        // Initialize Lucide icons after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });

        // Also try immediate call in case DOMContentLoaded already fired
        if (document.readyState !== 'loading') {
            lucide.createIcons();
        }
    </script>
</body>

</html>